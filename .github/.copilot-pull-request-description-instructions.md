# GitHub Copilot Pull Request 描述規範

## 📑 目錄

- [📋 PR 描述結構](#-pr-描述結構)
  - [基本模板](#基本模板)
- [🎯 不同類型 PR 的範例](#-不同類型-pr-的範例)
  - [新功能 PR](#新功能-pr)
  - [Bug 修復 PR](#bug-修復-pr)
  - [重構 PR](#重構-pr)
- [✅ PR 描述檢查清單](#-pr-描述檢查清單)
  - [內容完整性](#內容完整性)
  - [測試驗證](#測試驗證)
  - [文件同步](#文件同步)
  - [審查支援](#審查支援)
- [🎨 格式建議](#-格式建議)
  - [使用表情符號增加可讀性](#使用表情符號增加可讀性)
  - [使用 Markdown 格式](#使用-markdown-格式)
  - [保持簡潔但完整](#保持簡潔但完整)
- [📚 參考資源](#-參考資源)

---


> 本檔案定義 Pull Request 描述的標準格式，確保變更清楚記錄且易於審查。

## 📋 PR 描述結構

### 基本模板

```markdown
## 🎯 變更目的

[簡要說明這個 PR 要解決什麼問題或實現什麼功能]

## 📝 變更內容

### 主要變更
- [變更項目 1]
- [變更項目 2]
- [變更項目 3]

### 次要變更
- [次要變更項目 1]
- [次要變更項目 2]

## 🔍 技術細節

### 架構變更
[如有架構層面的變更，說明設計決策和理由]

### 資料模型變更
[如有資料表或 API 變更，說明影響範圍]

## ✅ 測試

### 測試範圍
- [ ] 單元測試
- [ ] 整合測試
- [ ] E2E 測試
- [ ] 手動測試

### 測試結果
```bash
yarn lint                  # ✅ 通過
yarn lint:style           # ✅ 通過
yarn type-check           # ✅ 通過
yarn test --watch=false   # ✅ 通過 (覆蓋率: 85%)
yarn build                # ✅ 成功建置
```mermaid
## 📸 截圖（如適用）

[如有 UI 變更，附上前後對比截圖]

## 🔗 相關連結

- Closes #123
- Refs #456
- 相關文件：`docs/xx-xxx.md`

## ⚠️ 注意事項

[任何需要特別注意的事項、限制或已知問題]

## 🚀 部署檢查清單

- [ ] 環境變數已更新
- [ ] 資料庫遷移已準備
- [ ] 文件已同步更新
- [ ] 向下相容性已確認

## 👥 審查者

@username - 請協助審查 [具體項目]
```

## 🎯 不同類型 PR 的範例

### 新功能 PR

```markdown
## 🎯 變更目的

實作任務批次操作功能，讓使用者可以同時管理多個任務，提升工作效率。

Closes #123

## 📝 變更內容

### 主要變更
- 新增任務批次選取 UI（Checkbox + 工具列）
- 實作批次狀態更新 API
- 新增批次刪除功能
- 加入操作記錄和 undo 功能

### 次要變更
- 優化任務列表渲染效能
- 更新任務服務的型別定義
- 新增相關單元測試

## 🔍 技術細節

### 架構變更
- 新增 `TaskBatchService` 處理批次操作
- 使用 Signals 管理選取狀態，確保反應式更新
- 採用樂觀更新策略提升使用者體驗

### 資料模型變更
無資料表變更，使用現有的任務 API。

### 關鍵程式碼
```typescript
// src/app/shared/services/task-batch.service.ts
export class TaskBatchService {
  private readonly selectedIds = signal<Set<string>>(new Set());

  async batchUpdate(ids: string[], updates: Partial<Task>): Promise<void> {
    // 樂觀更新
    this.applyOptimisticUpdate(ids, updates);

    try {
      await this.api.batchUpdate(ids, updates);
    } catch (error) {
      this.revertOptimisticUpdate(ids);
      throw error;
    }
  }
}

## ✅ 測試

### 測試範圍
- [x] 單元測試 - TaskBatchService 和相關元件
- [x] 整合測試 - API 批次操作
- [ ] E2E 測試 - 完整批次操作流程（下個 sprint）
- [x] 手動測試 - 各種邊界情況

### 測試結果
```bash
yarn lint                  # ✅ 通過
yarn lint:style           # ✅ 通過
yarn type-check           # ✅ 通過
yarn test --watch=false   # ✅ 通過 (覆蓋率: 87%)
yarn build                # ✅ 成功建置

### 手動測試案例
```mermaid
- ✅ 選取 100+ 個任務並批次更新
- ✅ 選取後取消操作
- ✅ 網路錯誤時正確回退
- ✅ 權限不足時顯示錯誤訊息

## 📸 截圖

### 批次選取 UI
![批次選取](./screenshots/batch-select.png)

### 批次操作工具列
![工具列](./screenshots/batch-toolbar.png)

## 🔗 相關連結

- Closes #123 - 任務批次操作需求
- Refs #124 - 效能優化追蹤
- 文件更新：`docs/features/task-management.md`

## ⚠️ 注意事項

1. 批次操作目前限制最多 500 個任務，避免效能問題
2. 使用者需要有相應權限才能執行批次操作
3. 批次刪除為軟刪除，可在 48 小時內復原

## 🚀 部署檢查清單

- [x] 環境變數已更新（無需變更）
- [x] 資料庫遷移已準備（無需遷移）
- [x] 文件已同步更新
- [x] 向下相容性已確認

## 👥 審查者

@tech-lead - 請審查整體架構設計
@frontend-dev - 請審查 UI/UX 實作
```

### Bug 修復 PR

```markdown
## 🎯 變更目的

修正任務狀態更新後，UI 沒有即時反映的問題。

Fixes #456

## 📝 變更內容

### 主要變更
- 修正 TaskService 的 Signals 更新邏輯
- 確保狀態變更後觸發元件更新
- 新增相關測試案例避免回歸

### 根本原因
原本使用 `this.tasks.set()` 但傳入的陣列引用相同，導致 Angular 的 Signals 沒有偵測到變更。

## 🔍 技術細節

### 修正方式
```typescript
// ❌ 錯誤：引用相同，Signals 無法偵測
updateTaskStatus(id: string, status: TaskStatus): void {
  const tasks = this.tasks();
  const task = tasks.find(t => t.id === id);
  if (task) {
    task.status = status;
    this.tasks.set(tasks); // 引用相同，不會觸發更新
  }
}

// ✅ 正確：建立新陣列，Signals 可以偵測
updateTaskStatus(id: string, status: TaskStatus): void {
  this.tasks.update(tasks =>
    tasks.map(task =>
      task.id === id ? { ...task, status } : task
    )
  );
}

## ✅ 測試

### 測試範圍
- [x] 單元測試 - 驗證 Signals 更新邏輯
- [x] 手動測試 - 確認 UI 正確更新

### 測試結果
```bash
yarn lint                  # ✅ 通過
yarn type-check           # ✅ 通過
yarn test --watch=false   # ✅ 通過

### 重現步驟（已修正）
1. 開啟任務列表
2. 更新任務狀態
```mermaid

## 🔗 相關連結

- Fixes #456
- 相關文件：`.cursor/rules/angular.mdc` (Signals 最佳實踐)

## ⚠️ 注意事項

這是常見的 Signals 使用陷阱，團隊成員請注意：
- 總是使用 `.update()` 或建立新物件
- 避免直接修改 Signal 內的物件屬性

## 🚀 部署檢查清單

- [x] 無需特殊部署步驟
- [x] 向下相容
```

### 重構 PR

```markdown
## 🎯 變更目的

重構使用者服務，採用 Signals API 取代傳統的 RxJS Subject，簡化狀態管理並提升效能。

## 📝 變更內容

### 主要變更
- 將 `UserService` 從 RxJS Subject 遷移至 Signals
- 更新所有相依元件以使用新的 API
- 移除不再需要的 subscription 管理

### 改善項目
- 減少記憶體使用（無需手動 unsubscribe）
- 提升型別安全（Signals 預設 readonly）
- 簡化狀態衍生邏輯（使用 computed）

## 🔍 技術細節

### API 變更對照

#### 舊版 (RxJS)
```typescript
export class UserService {
  private userSubject = new BehaviorSubject<User | null>(null);
  user$ = this.userSubject.asObservable();

  setUser(user: User): void {
    this.userSubject.next(user);
  }
}

// 元件中使用
ngOnInit() {
  this.subscription = this.userService.user$.subscribe(user => {
    this.user = user;
  });
}

ngOnDestroy() {
  this.subscription.unsubscribe();
}

#### 新版 (Signals)
```typescript
export class UserService {
  private readonly userSignal = signal<User | null>(null);
  readonly user = this.userSignal.asReadonly();

  setUser(user: User): void {
    this.userSignal.set(user);
  }
}

// 元件中使用
readonly user = inject(UserService).user;
// 模板中直接使用 {{ user()?.name }}

### 影響範圍
- `UserService` - 核心服務重構
- 15 個元件更新為使用 Signals API
- 移除 60+ 行的 subscription 管理程式碼

## ✅ 測試

### 測試範圍
- [x] 單元測試 - UserService 和相關元件全部更新
- [x] 整合測試 - 確認現有功能正常運作
- [x] 手動測試 - 完整使用者流程驗證

### 測試結果
```bash
yarn lint                  # ✅ 通過
yarn lint:style           # ✅ 通過
yarn type-check           # ✅ 通過
yarn test --watch=false   # ✅ 通過 (覆蓋率: 89%)
yarn build                # ✅ 成功建置

## 🔗 相關連結

- 文件：`.cursor/rules/modern-angular.mdc`
- 相關 issue: #789 (技術債務追蹤)

## ⚠️ 注意事項

### 重大變更
這是向下相容的重構，但有以下注意事項：

1. **外部使用者**：如果其他模組直接使用 `user$` Observable，需要更新為 `user` Signal
2. **測試更新**：相關測試案例已全部更新，但如有客製化的測試需同步調整

### 遷移指引
```typescript
// 舊的 Observable 訂閱
this.userService.user$.subscribe(user => { ... });

// 新的 Signal 使用
effect(() => {
  const user = this.userService.user();
  // ...
});

## 🚀 部署檢查清單

- [x] 向下相容性已確認
- [x] 文件已更新
- [x] 團隊成員已通知變更


```mermaid
```

## ✅ PR 描述檢查清單

提交 PR 前，確認以下項目：

### 內容完整性
- [ ] 清楚說明變更目的
- [ ] 列出所有重要變更
- [ ] 技術細節充分（如適用）
- [ ] 關聯相關 Issue

### 測試驗證
- [ ] 列出測試類型和範圍
- [ ] 提供測試結果（lint/type-check/test/build）
- [ ] 說明手動測試案例（如適用）
- [ ] 附上截圖（UI 變更）

### 文件同步
- [ ] 更新相關文件
- [ ] 註明文件變更位置
- [ ] 提供遷移指引（重大變更）

### 審查支援
- [ ] 標註需要特別關注的部分
- [ ] 指定合適的審查者
- [ ] 說明部署注意事項

## 🎨 格式建議

### 使用表情符號增加可讀性
- 🎯 目的
- 📝 內容
- 🔍 技術細節
- ✅ 測試
- 📸 截圖
- 🔗 連結
- ⚠️ 注意事項
- 🚀 部署
- 👥 審查者

### 使用 Markdown 格式
- 標題使用 `##`、`###`
- 列表使用 `-` 或數字
- 程式碼使用 ` ``` ` 區塊
- 勾選框使用 `- [ ]` 和 `- [x]`

### 保持簡潔但完整
- 主要變更優先說明
- 次要變更簡要列出
- 技術細節適度詳細
- 避免冗長的描述

## 📚 參考資源

- `.copilot-instructions.md` - 開發指引
- `.copilot-commit-message-instructions.md` - Commit 訊息規範
- `CONTRIBUTING.md` - 貢獻指南

- --

**版本**：v2.0
**最後更新**：2025-11-18
**維護者**：開發團隊
