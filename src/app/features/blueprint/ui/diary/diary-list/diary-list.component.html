<page-header [title]="'日誌管理'">
  <ng-template #extra>
    <button nz-button nzType="primary" (click)="onCreateDiary()">
      <i nz-icon nzType="plus"></i>
      新增日誌
    </button>
  </ng-template>
</page-header>

<nz-card [nzBordered]="false">
  <!-- Statistics -->
  <nz-row [nzGutter]="16" class="mb-md">
    <nz-col [nzSpan]="6">
      <nz-statistic [nzValue]="statistics().totalCount" [nzTitle]="'總日誌數'"></nz-statistic>
    </nz-col>
    <nz-col [nzSpan]="6">
      <nz-statistic [nzValue]="statistics().thisMonthCount" [nzTitle]="'本月日誌'"></nz-statistic>
    </nz-col>
    <nz-col [nzSpan]="6">
      <nz-statistic [nzValue]="statistics().averagePhotoCount" nzSuffix="張" [nzTitle]="'平均照片數'"></nz-statistic>
    </nz-col>
    <nz-col [nzSpan]="6">
      <nz-statistic [nzValue]="statistics().openIssueCount" [nzTitle]="'待處理問題'" [nzValueStyle]="{ color: statistics().openIssueCount > 0 ? '#cf1322' : '#3f8600' }"></nz-statistic>
    </nz-col>
  </nz-row>

  <nz-divider></nz-divider>

  <!-- Search and Filter -->
  <nz-row [nzGutter]="16" class="mb-md">
    <nz-col [nzSpan]="12">
      <nz-input-group [nzPrefix]="prefixIconSearch">
        <input type="text" nz-input placeholder="搜尋日誌標題、內容..." (ngModelChange)="onSearch($event)" [ngModel]="searchTerm()" />
      </nz-input-group>
      <ng-template #prefixIconSearch>
        <i nz-icon nzType="search"></i>
      </ng-template>
    </nz-col>
    <nz-col [nzSpan]="6">
      <nz-date-picker nzMode="month" [(ngModel)]="selectedMonth" (ngModelChange)="onMonthChange($event)" [nzAllowClear]="false"></nz-date-picker>
    </nz-col>
  </nz-row>

  <!-- Loading -->
  @if (loading()) {
    <nz-spin [nzSpinning]="true" nzTip="載入中...">
      <div style="height: 200px;"></div>
    </nz-spin>
  }

  <!-- Error -->
  @if (error()) {
    <nz-alert nzType="error" [nzMessage]="error()" nzShowIcon class="mb-md"></nz-alert>
  }

  <!-- Empty State -->
  @if (!loading() && filteredDiaries().length === 0) {
    <nz-empty nzNotFoundImage="simple" [nzNotFoundContent]="'暫無日誌記錄'">
      <ng-template #nzNotFoundFooter>
        <button nz-button nzType="primary" (click)="onCreateDiary()">新增第一篇日誌</button>
      </ng-template>
    </nz-empty>
  }

  <!-- Diary List -->
  @if (!loading() && filteredDiaries().length > 0) {
    <nz-list nzItemLayout="vertical">
      @for (diary of filteredDiaries(); track trackByDiary($index, diary)) {
        <nz-list-item>
          <nz-list-item-meta>
            <nz-list-item-meta-avatar>
              <nz-avatar [nzIcon]="getWeatherIcon(diary.weather)"></nz-avatar>
            </nz-list-item-meta-avatar>
            <nz-list-item-meta-title>
              <a (click)="onViewDiary(diary)">{{ diary.title }}</a>
              <nz-tag class="ml-sm" nzColor="blue">{{ diary.weatherLabel }}</nz-tag>
              @if (diary.temperature) {
                <span class="text-grey ml-sm">{{ diary.temperature }}°C</span>
              }
            </nz-list-item-meta-title>
            <nz-list-item-meta-description>
              <span>{{ diary.formattedDate }}</span>
              <nz-divider nzType="vertical"></nz-divider>
              <span>{{ diary.authorName }}</span>
              <nz-divider nzType="vertical"></nz-divider>
              <span><i nz-icon nzType="camera"></i> {{ diary.photoCount }} 張照片</span>
              @if (diary.openIssueCount > 0) {
                <nz-divider nzType="vertical"></nz-divider>
                <span class="text-error"><i nz-icon nzType="warning"></i> {{ diary.openIssueCount }} 待處理問題</span>
              }
            </nz-list-item-meta-description>
          </nz-list-item-meta>
          <p>{{ diary.summary || '無摘要' }}</p>
          <nz-list-item-extra>
            <button nz-button nzType="link" (click)="onViewDiary(diary)">
              <i nz-icon nzType="eye"></i>
            </button>
            <button nz-button nzType="link" (click)="onEditDiary(diary)">
              <i nz-icon nzType="edit"></i>
            </button>
            <button nz-button nzType="link" nzDanger (click)="onDeleteDiary(diary)">
              <i nz-icon nzType="delete"></i>
            </button>
          </nz-list-item-extra>
        </nz-list-item>
      }
    </nz-list>
  }
</nz-card>
