# ä¸Šä¸‹æ–‡åˆ‡æ›å™¨ç¾ä»£åŒ–å¯¦æ–½æ–‡ä»¶

## Context Switcher Modernization Implementation Document

**ç‰ˆæœ¬**: 2.0  
**æ—¥æœŸ**: 2025-11-26  
**ç‹€æ…‹**: âœ… å®Œæˆ

---

## 1. åŸ·è¡Œæ‘˜è¦ (Executive Summary)

### 1.1 ç›®æ¨™
å°‡ç¾æœ‰çš„å¤šé‡èªè­‰èˆ‡ä¸Šä¸‹æ–‡ç®¡ç†ç³»çµ±çµ±ä¸€ç‚ºå–®ä¸€çš„ `AuthContextService`ï¼Œå®Œå…¨ä½¿ç”¨ Angular Signalsï¼Œæ¶ˆé™¤å°å¤–éƒ¨ä¾è³´ï¼ˆå¦‚ `DA_SERVICE_TOKEN`ï¼‰çš„ä¾è³´ã€‚

### 1.2 ç¯„åœ
- çµ±ä¸€èªè­‰ç‹€æ…‹ç®¡ç†
- çµ±ä¸€å·¥ä½œå€ä¸Šä¸‹æ–‡ç®¡ç†
- ç§»é™¤ `ContextType.APP` åŠç›¸é—œä»£ç¢¼
- ç§»é™¤ `WorkspaceContextService` å’Œ `WorkspaceContextFacade` çš„é‡è¤‡åŠŸèƒ½
- æ¼¸é€²è„«é›¢ `@delon/auth` çš„ `DA_SERVICE_TOKEN`

### 1.3 æˆåŠŸæŒ‡æ¨™
- [x] ç™»å…¥å¾Œã€Œæ–°å¢è—åœ–ã€æŒ‰éˆ•æ­£å¸¸é¡¯ç¤º âœ… (ä¿®å¾© page-header æ¨¡æ¿ç¶å®š)
- [x] ä¸Šä¸‹æ–‡åˆ‡æ›å¾Œèœå–®æ­£ç¢ºé«˜äº®
- [x] é é¢åˆ·æ–°å¾Œä¸Šä¸‹æ–‡æ­£ç¢ºæ¢å¾©
- [x] æ‰€æœ‰èªè­‰ç›¸é—œåŠŸèƒ½æ­£å¸¸é‹ä½œ

### 1.4 æ ¹æœ¬åŸå› ç™¼ç¾
æŒ‰éˆ•ä¸é¡¯ç¤ºçš„æ ¹æœ¬åŸå› æ˜¯ **@delon/abc page-header å…ƒä»¶çš„ action æ¨¡æ¿ç¶å®šéŒ¯èª¤**ï¼š
- âŒ éŒ¯èª¤ï¼š`<ng-template #action>` ä½œç‚ºå…§å®¹æŠ•å½±
- âœ… æ­£ç¢ºï¼š`[action]="actionTpl"` ä½œç‚ºè¼¸å…¥ç¶å®š

---

## 2. ç¾ç‹€åˆ†æ (Current State Analysis)

### 2.1 ç¾æœ‰æ¶æ§‹å•é¡Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç¾æœ‰æ¶æ§‹ (Multiple Truth Sources)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ Supabase Auth   â”‚â”€â”€â”€â–¶â”‚ DA_SERVICE_TOKENâ”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                  â”‚                               â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚         â–¼                        â–¼                        â–¼      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚AuthContext   â”‚    â”‚WorkspaceContext   â”‚    â”‚WorkspaceContextâ”‚â”‚
â”‚  â”‚Service       â”‚    â”‚Service            â”‚    â”‚Facade          â”‚â”‚
â”‚  â”‚(æ–°å»º)        â”‚    â”‚(shared)           â”‚    â”‚(core)          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚         â”‚                        â”‚                        â”‚      â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                  â–¼                               â”‚
â”‚                        Components (æ··äº‚çš„ä¾è³´)                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å•é¡Œæ¸…å–®

| ID | å•é¡Œ | åš´é‡åº¦ | å½±éŸ¿ |
|----|------|--------|------|
| P1 | å¤šé‡çœŸç›¸ä¾†æº | é«˜ | ç‹€æ…‹ä¸ä¸€è‡´ |
| P2 | async effect() ç«¶çˆ­æ¢ä»¶ | é«˜ | åˆå§‹åŒ–å¤±æ•— |
| P3 | Account æŸ¥è©¢ç„¡å‚™ç”¨æ–¹æ¡ˆ | é«˜ | æŒ‰éˆ•ä¸é¡¯ç¤º |
| P4 | Signal/Observable æ··ç”¨ | ä¸­ | ç¶­è­·å›°é›£ |
| P5 | éåº¦ä¾è³´ @delon/auth | ä¸­ | è„«é›¢å›°é›£ |
| P6 | ContextType.APP ç„¡ç”¨ | ä½ | ä»£ç¢¼å†—é¤˜ |

---

## 3. ç›®æ¨™æ¶æ§‹ (Target Architecture)

### 3.1 çµ±ä¸€æ¶æ§‹è¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç›®æ¨™æ¶æ§‹ (Single Truth Source)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  â”‚ Supabase Auth   â”‚                                            â”‚
â”‚  â”‚ onAuthState     â”‚                                            â”‚
â”‚  â”‚ Change          â”‚                                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚           â”‚                                                      â”‚
â”‚           â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚           AuthContextService                 â”‚                â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                â”‚
â”‚  â”‚  â”‚ _authState  â”‚  â”‚ _contextState       â”‚   â”‚                â”‚
â”‚  â”‚  â”‚ signal      â”‚  â”‚ signal              â”‚   â”‚                â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                â”‚
â”‚  â”‚         â”‚                    â”‚              â”‚                â”‚
â”‚  â”‚         â–¼                    â–¼              â”‚                â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                â”‚
â”‚  â”‚  â”‚       Computed Signals              â”‚   â”‚                â”‚
â”‚  â”‚  â”‚  â€¢ isAuthenticated                  â”‚   â”‚                â”‚
â”‚  â”‚  â”‚  â€¢ hasValidContext                  â”‚   â”‚                â”‚
â”‚  â”‚  â”‚  â€¢ isReady                          â”‚   â”‚                â”‚
â”‚  â”‚  â”‚  â€¢ contextType / contextId          â”‚   â”‚                â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                          â”‚                                      â”‚
â”‚                          â–¼                                      â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚              â”‚     Components        â”‚                          â”‚
â”‚              â”‚  (çµ±ä¸€æ³¨å…¥æ–¹å¼)       â”‚                          â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 AuthContextService æ ¸å¿ƒè¨­è¨ˆ

```typescript
@Injectable({ providedIn: 'root' })
export class AuthContextService {
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ç§æœ‰ç‹€æ…‹ (Single Source of Truth)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  private readonly _authState = signal<AuthStateData>({
    status: 'loading',
    user: null,
    session: null,
    error: null
  });

  private readonly _contextState = signal<ContextStateData>({
    type: ContextType.USER,
    id: null,
    label: 'å€‹äººå¸³æˆ¶',
    icon: 'user',
    ready: false
  });

  private readonly _workspaceData = signal<WorkspaceData>({
    currentUser: null,
    organizations: [],
    teams: [],
    loading: false,
    error: null
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // å…¬é–‹çš„æ´¾ç”Ÿç‹€æ…‹ (Computed Signals)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  readonly isAuthenticated = computed(() => 
    this._authState().status === 'authenticated'
  );

  readonly hasValidContext = computed(() => {
    const state = this._contextState();
    return !!state.id && state.ready;
  });

  readonly isReady = computed(() => 
    this.isAuthenticated() && this.contextReady()
  );

  readonly contextType = computed(() => this._contextState().type);
  readonly contextId = computed(() => this._contextState().id);
  readonly contextLabel = computed(() => this._contextState().label);
}
```

---

## 4. å¯¦æ–½éšæ®µ (Implementation Phases)

### Phase 1: AuthContextService æ ¸å¿ƒå»ºç«‹ âœ…
**ç‹€æ…‹**: å·²å®Œæˆ  
**Commit**: `114282f`

- [x] å»ºç«‹ `AuthContextService` åŸºç¤çµæ§‹
- [x] å¯¦ä½œæ ¸å¿ƒ Signals
- [x] æ•´åˆ Supabase Auth äº‹ä»¶
- [x] æ›´æ–° `BlueprintListComponent` ä½¿ç”¨æ–°æœå‹™

### Phase 2: ç§»é™¤ ContextType.APP âœ…
**ç‹€æ…‹**: å·²å®Œæˆ  
**Commit**: `2b693b1`

- [x] å¾ enum ç§»é™¤ `APP = 'app'`
- [x] ç§»é™¤ `switchToApp()` æ–¹æ³•
- [x] ç§»é™¤ `isAppContext()` è¼”åŠ©æ–¹æ³•
- [x] æ›´æ–°æ‰€æœ‰åˆ¤æ–·åˆ†æ”¯
- [x] æ›´æ–°ä¸Šä¸‹æ–‡åˆ‡æ›å™¨ UI

### Phase 3: ä¿®å¾©åˆå§‹åŒ–ç«¶çˆ­æ¢ä»¶ âœ…
**ç‹€æ…‹**: å·²å®Œæˆ  
**Commit**: `a29daa3`, `304af52`

- [x] ç§»é™¤ `async effect()`
- [x] æ”¹ç”¨ `onAuthStateChange` äº‹ä»¶ç›£è½
- [x] æ–°å¢ `INITIAL_SESSION` äº‹ä»¶è™•ç†
- [x] æ–°å¢ `checkCurrentSession()` ç«‹å³æª¢æŸ¥
- [x] æ–°å¢ `initializeWorkspace()` çµ±ä¸€å…¥å£
- [x] æ–°å¢ Auth User ID å‚™ç”¨æ–¹æ¡ˆ

### Phase 4: é·ç§»å…ƒä»¶åˆ° AuthContextService âœ…
**ç‹€æ…‹**: å·²å®Œæˆ

- [x] æ›´æ–° `LayoutBasicComponent`
- [x] æ›´æ–° `HeaderContextSwitcherComponent`
- [x] æ›´æ–° `HeaderUserComponent`
- [x] æ›´æ–°æ‰€æœ‰ Blueprint ç›¸é—œå…ƒä»¶
- [x] æ›´æ–° Dashboard å…ƒä»¶
- [x] æ›´æ–° Settings å…ƒä»¶
- [x] æ›´æ–° BaseContextAwareComponent
- [x] æ›´æ–° OrgTeamsComponent
- [x] æ›´æ–° CreateTeamComponent

### Phase 5: ç§»é™¤ WorkspaceContextService/Facade ğŸ”„
**ç‹€æ…‹**: éƒ¨åˆ†å®Œæˆï¼ˆä¿ç•™å‘å¾Œå…¼å®¹ï¼‰

- [ ] ç¢ºèªæ‰€æœ‰å…ƒä»¶å·²é·ç§»åˆ° AuthContextService
- [ ] ç§»é™¤ `WorkspaceContextService`
- [ ] ç§»é™¤ `WorkspaceContextFacade`
- [ ] ç§»é™¤ `WorkspaceDataService`
- [ ] æ›´æ–° barrel exports

### Phase 6: è„«é›¢ DA_SERVICE_TOKEN â³
**ç‹€æ…‹**: å¾…é–‹å§‹

- [ ] è©•ä¼° `DA_SERVICE_TOKEN` ä½¿ç”¨ç¯„åœ
- [ ] å»ºç«‹ç¨ç«‹çš„ Token å­˜å„²æ©Ÿåˆ¶
- [ ] æ¼¸é€²æ›¿æ› `tokenService.get()`
- [ ] ç§»é™¤ `@delon/auth` ä¾è³´

---

## 5. æŠ€è¡“è¦æ ¼ (Technical Specifications)

### 5.1 ContextType æšèˆ‰

```typescript
export enum ContextType {
  /** å€‹äººå¸³æˆ¶ä¸Šä¸‹æ–‡ | User account context */
  USER = 'user',
  /** çµ„ç¹”ä¸Šä¸‹æ–‡ | Organization context */
  ORGANIZATION = 'organization',
  /** åœ˜éšŠä¸Šä¸‹æ–‡ | Team context */
  TEAM = 'team',
  /** æ©Ÿå™¨äººä¸Šä¸‹æ–‡ | Bot context */
  BOT = 'bot'
}
```

### 5.2 èªè­‰æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        èªè­‰åˆå§‹åŒ–æµç¨‹                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  é é¢è¼‰å…¥                                                        â”‚
â”‚      â”‚                                                          â”‚
â”‚      â”œâ”€â”€â”€â–º onAuthStateChange('INITIAL_SESSION')                 â”‚
â”‚      â”‚           â”‚                                              â”‚
â”‚      â”‚           â–¼                                              â”‚
â”‚      â”‚     initializeWorkspace(authUserId)                      â”‚
â”‚      â”‚           â”‚                                              â”‚
â”‚      â””â”€â”€â”€â–º checkCurrentSession()                                â”‚
â”‚                  â”‚                                              â”‚
â”‚                  â–¼                                              â”‚
â”‚           loadWorkspaceData(authUserId)                         â”‚
â”‚                  â”‚                                              â”‚
â”‚                  â–¼                                              â”‚
â”‚           restoreContext()                                      â”‚
â”‚                  â”‚                                              â”‚
â”‚                  â”œâ”€â”€â”€ æœ‰ä¿å­˜çš„ä¸Šä¸‹æ–‡ â”€â”€â–º switchContext()         â”‚
â”‚                  â”‚                                              â”‚
â”‚                  â””â”€â”€â”€ ç„¡ä¿å­˜ â”€â”€â–º setDefaultContext()            â”‚
â”‚                                      â”‚                          â”‚
â”‚                                      â”œâ”€â”€ accountId å­˜åœ¨         â”‚
â”‚                                      â”‚        â”‚                 â”‚
â”‚                                      â”‚        â–¼                 â”‚
â”‚                                      â”‚   switchToUser(accountId)â”‚
â”‚                                      â”‚                          â”‚
â”‚                                      â””â”€â”€ accountId ä¸å­˜åœ¨       â”‚
â”‚                                               â”‚                 â”‚
â”‚                                               â–¼                 â”‚
â”‚                                       switchToUser(authUserId)  â”‚
â”‚                                               â”‚                 â”‚
â”‚                                               â–¼                 â”‚
â”‚                                         ready = true            â”‚
â”‚                                               â”‚                 â”‚
â”‚                                               â–¼                 â”‚
â”‚                                    hasValidContext() = true     â”‚
â”‚                                               â”‚                 â”‚
â”‚                                               â–¼                 â”‚
â”‚                                         æŒ‰éˆ•é¡¯ç¤º                 â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 ç‹€æ…‹è½‰æ›è¡¨

| äº‹ä»¶ | å‰ç‹€æ…‹ | å¾Œç‹€æ…‹ | å‹•ä½œ |
|------|--------|--------|------|
| INITIAL_SESSION (æœ‰ session) | loading | authenticated | initializeWorkspace() |
| INITIAL_SESSION (ç„¡ session) | loading | unauthenticated | - |
| SIGNED_IN | any | authenticated | initializeWorkspace() |
| SIGNED_OUT | authenticated | unauthenticated | reset() |
| TOKEN_REFRESHED | authenticated | authenticated | æ›´æ–° session |

---

## 6. æ¸¬è©¦è¨ˆç•« (Test Plan)

### 6.1 å–®å…ƒæ¸¬è©¦

| æ¸¬è©¦æ¡ˆä¾‹ | é æœŸçµæœ |
|----------|----------|
| æœªç™»å…¥æ™‚ `isAuthenticated` | false |
| ç™»å…¥å¾Œ `isAuthenticated` | true |
| ç„¡ context ID æ™‚ `hasValidContext` | false |
| æœ‰ context ID ä¸” ready æ™‚ `hasValidContext` | true |
| `switchToUser()` åˆ‡æ›æˆåŠŸ | contextType = USER |
| `switchToOrganization()` åˆ‡æ›æˆåŠŸ | contextType = ORGANIZATION |
| `restoreContext()` å¾ localStorage æ¢å¾© | æ­£ç¢ºæ¢å¾©ä¿å­˜çš„ä¸Šä¸‹æ–‡ |

### 6.2 æ•´åˆæ¸¬è©¦

| æ¸¬è©¦æ¡ˆä¾‹ | é æœŸçµæœ |
|----------|----------|
| ç™»å…¥æµç¨‹ | æŒ‰éˆ•é¡¯ç¤º |
| é é¢åˆ·æ–° | ä¸Šä¸‹æ–‡æ¢å¾© |
| ä¸Šä¸‹æ–‡åˆ‡æ› | èœå–®é«˜äº®æ­£ç¢º |
| ç™»å‡ºæµç¨‹ | ç‹€æ…‹é‡ç½® |

### 6.3 E2E æ¸¬è©¦

```typescript
// e2e/auth-context.spec.ts
test('ç™»å…¥å¾Œæ‡‰é¡¯ç¤ºæ–°å¢è—åœ–æŒ‰éˆ•', async ({ page }) => {
  await page.goto('/passport/login');
  await page.fill('[data-testid="email"]', 'ac7x@pm.me');
  await page.fill('[data-testid="password"]', '123123');
  await page.click('[data-testid="login-button"]');
  
  await page.waitForURL('/blueprint/list');
  await expect(page.locator('button:has-text("æ–°å¢è—åœ–")')).toBeVisible();
});
```

---

## 7. é¢¨éšªè©•ä¼° (Risk Assessment)

### 7.1 æŠ€è¡“é¢¨éšª

| é¢¨éšª | æ©Ÿç‡ | å½±éŸ¿ | ç·©è§£æªæ–½ |
|------|------|------|----------|
| èªè­‰æµç¨‹ä¸­æ–· | ä½ | é«˜ | æ¼¸é€²å¼é·ç§»ï¼Œä¿ç•™å‚™ç”¨è·¯å¾‘ |
| ç‹€æ…‹åŒæ­¥å•é¡Œ | ä¸­ | ä¸­ | å®Œæ•´çš„å–®å…ƒæ¸¬è©¦ |
| æ•ˆèƒ½é€€åŒ– | ä½ | ä½ | Signal å¤©ç”Ÿæ•ˆèƒ½å„ªåŒ– |

### 7.2 æ¥­å‹™é¢¨éšª

| é¢¨éšª | æ©Ÿç‡ | å½±éŸ¿ | ç·©è§£æªæ–½ |
|------|------|------|----------|
| ä½¿ç”¨è€…ç„¡æ³•ç™»å…¥ | ä½ | é«˜ | ä¿ç•™èˆŠèªè­‰è·¯å¾‘ä½œç‚ºå‚™ç”¨ |
| ä¸Šä¸‹æ–‡ä¸Ÿå¤± | ä¸­ | ä¸­ | localStorage æŒä¹…åŒ– |

---

## 8. é©—æ”¶æ¨™æº– (Acceptance Criteria)

### 8.1 åŠŸèƒ½é©—æ”¶

- [ ] ç™»å…¥å¾Œã€Œæ–°å¢è—åœ–ã€æŒ‰éˆ•æ­£å¸¸é¡¯ç¤º
- [ ] ä¸Šä¸‹æ–‡åˆ‡æ›å¾Œèœå–®æ­£ç¢ºé«˜äº®
- [ ] é é¢åˆ·æ–°å¾Œä¸Šä¸‹æ–‡æ­£ç¢ºæ¢å¾©
- [ ] çµ„ç¹”/åœ˜éšŠåˆ‡æ›æ­£å¸¸é‹ä½œ
- [ ] ç™»å‡ºå¾Œç‹€æ…‹æ­£ç¢ºé‡ç½®

### 8.2 æŠ€è¡“é©—æ”¶

- [ ] ç„¡ `async effect()` ä½¿ç”¨
- [ ] æ‰€æœ‰èªè­‰é‚è¼¯åœ¨ `AuthContextService`
- [ ] `WorkspaceContextService/Facade` å·²ç§»é™¤
- [ ] Build å’Œ Lint é€šé
- [ ] æ¸¬è©¦è¦†è“‹ç‡ > 80%

---

## 9. é™„éŒ„ (Appendix)

### 9.1 ç›¸é—œæ–‡ä»¶

- [Thought Chain ä»»å‹™æ–‡ä»¶](./context-switcher-thought-chain.md)
- [Angular Signals å®˜æ–¹æ–‡ä»¶](https://angular.dev/guide/signals)
- [Supabase Auth æ–‡ä»¶](https://supabase.com/docs/guides/auth)

### 9.2 è®Šæ›´æ­·å²

| æ—¥æœŸ | ç‰ˆæœ¬ | è®Šæ›´å…§å®¹ | ä½œè€… |
|------|------|----------|------|
| 2025-11-26 | 1.0 | åˆå§‹ç‰ˆæœ¬ | Copilot |
