# éŒ¯èª¤è™•ç†æŒ‡å—


> **ğŸ“š ç›®çš„**: å®šç¾©çµ±ä¸€çš„éŒ¯èª¤è™•ç†ç­–ç•¥ï¼Œæå‡æ‡‰ç”¨ç¨‹å¼çš„ç©©å®šæ€§èˆ‡ç”¨æˆ¶é«”é©—

## ç›®æ¨™è®€è€… (Audience)

- å‰ç«¯é–‹ç™¼è€…
- å¾Œç«¯é–‹ç™¼è€…

---


## ğŸ“‘ ç›®éŒ„

- [ğŸ“‹ ç›®éŒ„](#-ç›®éŒ„)
- [éŒ¯èª¤è™•ç†æ¦‚è¿°](#éŒ¯èª¤è™•ç†æ¦‚è¿°)
  - [æ ¸å¿ƒçµ„ä»¶](#æ ¸å¿ƒçµ„ä»¶)
  - [è‡ªå‹•è™•ç†](#è‡ªå‹•è™•ç†)
- [éŒ¯èª¤åˆ†é¡](#éŒ¯èª¤åˆ†é¡)
  - [éŒ¯èª¤é¡å‹ï¼ˆErrorTypeï¼‰](#éŒ¯èª¤é¡å‹errortype)
  - [éŒ¯èª¤åš´é‡ç¨‹åº¦ï¼ˆErrorSeverityï¼‰](#éŒ¯èª¤åš´é‡ç¨‹åº¦errorseverity)
- [éŒ¯èª¤ç¢¼å®šç¾©](#éŒ¯èª¤ç¢¼å®šç¾©)
  - [HTTP éŒ¯èª¤ç¢¼](#http-éŒ¯èª¤ç¢¼)
  - [ç¶²è·¯éŒ¯èª¤ç¢¼](#ç¶²è·¯éŒ¯èª¤ç¢¼)
  - [é©—è­‰éŒ¯èª¤ç¢¼](#é©—è­‰éŒ¯èª¤ç¢¼)
  - [æ¥­å‹™éŒ¯èª¤ç¢¼](#æ¥­å‹™éŒ¯èª¤ç¢¼)
  - [æ¬Šé™éŒ¯èª¤ç¢¼](#æ¬Šé™éŒ¯èª¤ç¢¼)
  - [Git-like åˆ†æ”¯éŒ¯èª¤ç¢¼](#git-like-åˆ†æ”¯éŒ¯èª¤ç¢¼)
- [ä½¿ç”¨ ErrorStateService](#ä½¿ç”¨-errorstateservice)
  - [åŸºæœ¬ä½¿ç”¨](#åŸºæœ¬ä½¿ç”¨)
  - [è‡ªå‹• HTTP éŒ¯èª¤è™•ç†](#è‡ªå‹•-http-éŒ¯èª¤è™•ç†)
  - [æ‰‹å‹•æ·»åŠ éŒ¯èª¤](#æ‰‹å‹•æ·»åŠ éŒ¯èª¤)
- [å‰ç«¯éŒ¯èª¤é¡¯ç¤º](#å‰ç«¯éŒ¯èª¤é¡¯ç¤º)
  - [ä½¿ç”¨ ErrorBannerComponent](#ä½¿ç”¨-errorbannercomponent)
  - [åœ¨çµ„ä»¶ä¸­é¡¯ç¤ºéŒ¯èª¤](#åœ¨çµ„ä»¶ä¸­é¡¯ç¤ºéŒ¯èª¤)
- [å¾Œç«¯éŒ¯èª¤å›æ‡‰](#å¾Œç«¯éŒ¯èª¤å›æ‡‰)
  - [Supabase PostgREST éŒ¯èª¤æ ¼å¼](#supabase-postgrest-éŒ¯èª¤æ ¼å¼)
  - [Edge Functions éŒ¯èª¤æ ¼å¼](#edge-functions-éŒ¯èª¤æ ¼å¼)
- [éŒ¯èª¤æ—¥èªŒè¨˜éŒ„](#éŒ¯èª¤æ—¥èªŒè¨˜éŒ„)
  - [å‰ç«¯éŒ¯èª¤æ—¥èªŒ](#å‰ç«¯éŒ¯èª¤æ—¥èªŒ)
  - [å¾Œç«¯éŒ¯èª¤æ—¥èªŒ](#å¾Œç«¯éŒ¯èª¤æ—¥èªŒ)
  - [éŒ¯èª¤è¿½è¹¤](#éŒ¯èª¤è¿½è¹¤)
- [æœ€ä½³å¯¦è¸](#æœ€ä½³å¯¦è¸)
  - [1. éŒ¯èª¤åˆ†é¡åŸå‰‡](#1-éŒ¯èª¤åˆ†é¡åŸå‰‡)
  - [2. åš´é‡ç¨‹åº¦é¸æ“‡](#2-åš´é‡ç¨‹åº¦é¸æ“‡)
  - [3. éŒ¯èª¤è¨Šæ¯æ’°å¯«](#3-éŒ¯èª¤è¨Šæ¯æ’°å¯«)
  - [4. éŒ¯èª¤ä¾†æºæ¨™è¨˜](#4-éŒ¯èª¤ä¾†æºæ¨™è¨˜)
  - [5. éŒ¯èª¤å…ƒæ•¸æ“š](#5-éŒ¯èª¤å…ƒæ•¸æ“š)
  - [6. é¿å…é‡è¤‡éŒ¯èª¤](#6-é¿å…é‡è¤‡éŒ¯èª¤)
  - [7. éŒ¯èª¤é‡è©¦](#7-éŒ¯èª¤é‡è©¦)
- [å®Œæ•´ç¯„ä¾‹](#å®Œæ•´ç¯„ä¾‹)
  - [ç¯„ä¾‹ 1ï¼šæœå‹™ä¸­çš„éŒ¯èª¤è™•ç†](#ç¯„ä¾‹-1æœå‹™ä¸­çš„éŒ¯èª¤è™•ç†)
  - [ç¯„ä¾‹ 2ï¼šçµ„ä»¶ä¸­çš„éŒ¯èª¤è™•ç†](#ç¯„ä¾‹-2çµ„ä»¶ä¸­çš„éŒ¯èª¤è™•ç†)
  - [ç¯„ä¾‹ 3ï¼šè¡¨å–®é©—è­‰éŒ¯èª¤](#ç¯„ä¾‹-3è¡¨å–®é©—è­‰éŒ¯èª¤)
- [API åƒè€ƒ](#api-åƒè€ƒ)
  - [ErrorStateService æ–¹æ³•](#errorstateservice-æ–¹æ³•)
  - [ErrorStateService å±¬æ€§ï¼ˆSignalï¼‰](#errorstateservice-å±¬æ€§signal)
- [ç›¸é—œæ–‡æª”](#ç›¸é—œæ–‡æª”)

---


> ğŸ“‹ **ç›®çš„**ï¼šçµ±ä¸€éŒ¯èª¤è™•ç†æ–¹å¼ï¼Œç¢ºä¿éŒ¯èª¤è™•ç†çš„ä¸€è‡´æ€§å’Œä½¿ç”¨è€…é«”é©—

**æœ€å¾Œæ›´æ–°**ï¼š2025-11-15
**ç¶­è­·è€…**ï¼šé–‹ç™¼åœ˜éšŠ

- --

## ğŸ“‹ ç›®éŒ„

- [éŒ¯èª¤è™•ç†æ¦‚è¿°](#éŒ¯èª¤è™•ç†æ¦‚è¿°)
- [éŒ¯èª¤åˆ†é¡](#éŒ¯èª¤åˆ†é¡)
- [éŒ¯èª¤ç¢¼å®šç¾©](#éŒ¯èª¤ç¢¼å®šç¾©)
- [ä½¿ç”¨ ErrorStateService](#ä½¿ç”¨-errorstateservice)
- [å‰ç«¯éŒ¯èª¤é¡¯ç¤º](#å‰ç«¯éŒ¯èª¤é¡¯ç¤º)
- [å¾Œç«¯éŒ¯èª¤å›æ‡‰](#å¾Œç«¯éŒ¯èª¤å›æ‡‰)
- [éŒ¯èª¤æ—¥èªŒè¨˜éŒ„](#éŒ¯èª¤æ—¥èªŒè¨˜éŒ„)
- [æœ€ä½³å¯¦è¸](#æœ€ä½³å¯¦è¸)

**åƒè€ƒæ–‡æª”**ï¼š
- [é–‹ç™¼ä½œæ¥­æŒ‡å¼•](./specs/00-development-guidelines.md) - éŒ¯èª¤è™•ç†è¦ç¯„
- `src/app/core/net/error/ERROR_HANDLING_GUIDE.md` - è©³ç´°ä½¿ç”¨æ‰‹å†Š
- [APIæ¥å£è©³ç´°æ–‡æª”](./33-API-æ¥å£è©³ç´°æ–‡æª”.md) - API éŒ¯èª¤è™•ç†

- --

## éŒ¯èª¤è™•ç†æ¦‚è¿°

å°ˆæ¡ˆä½¿ç”¨çµ±ä¸€çš„éŒ¯èª¤è™•ç†ç³»çµ±ï¼Œé€é `ErrorStateService` ç®¡ç†æ‰€æœ‰éŒ¯èª¤ç‹€æ…‹ã€‚

### æ ¸å¿ƒçµ„ä»¶

- **ErrorStateService** - éŒ¯èª¤ç‹€æ…‹ç®¡ç†æœå‹™
- **defaultInterceptor** - HTTP éŒ¯èª¤è‡ªå‹•æ””æˆª
- **ErrorBannerComponent** - éŒ¯èª¤æ©«å¹…é¡¯ç¤ºçµ„ä»¶

### è‡ªå‹•è™•ç†

æ‰€æœ‰ HTTP éŒ¯èª¤æœƒé€é `defaultInterceptor` è‡ªå‹•è¨˜éŒ„åˆ° `ErrorStateService`ï¼Œç„¡éœ€æ‰‹å‹•è™•ç†ã€‚

- --

## éŒ¯èª¤åˆ†é¡

### éŒ¯èª¤é¡å‹ï¼ˆErrorTypeï¼‰

| é¡å‹ | èªªæ˜ | ç¯„ä¾‹ |
|------|------|------|
| `http` | HTTP è«‹æ±‚éŒ¯èª¤ | 4xxã€5xx ç‹€æ…‹ç¢¼ |
| `network` | ç¶²è·¯é€£ç·šéŒ¯èª¤ | é€£ç·šå¤±æ•—ã€è¶…æ™‚ |
| `validation` | è¡¨å–®é©—è­‰éŒ¯èª¤ | æ¬„ä½é©—è­‰å¤±æ•— |
| `business` | æ¥­å‹™é‚è¼¯éŒ¯èª¤ | æ¥­å‹™è¦å‰‡é•å |
| `permission` | æ¬Šé™éŒ¯èª¤ | ç„¡æ¬Šé™è¨ªå• |
| `unknown` | æœªçŸ¥éŒ¯èª¤ | æœªåˆ†é¡éŒ¯èª¤ |

### éŒ¯èª¤åš´é‡ç¨‹åº¦ï¼ˆErrorSeverityï¼‰

| åš´é‡ç¨‹åº¦ | èªªæ˜ | ä½¿ç”¨å ´æ™¯ |
|---------|------|---------|
| `critical` | åš´é‡éŒ¯èª¤ | ç³»çµ±ç´šéŒ¯èª¤ï¼Œéœ€ç«‹å³è™•ç†ï¼ˆå¦‚ 500 éŒ¯èª¤ï¼‰ |
| `error` | ä¸€èˆ¬éŒ¯èª¤ | éœ€è¦è™•ç†çš„éŒ¯èª¤ï¼ˆå¦‚ 400ã€404 éŒ¯èª¤ï¼‰ |
| `warning` | è­¦å‘Š | å¯å¿½ç•¥çš„è­¦å‘Šï¼ˆå¦‚é©—è­‰è­¦å‘Šï¼‰ |
| `info` | è³‡è¨Šæç¤º | åƒ…æç¤ºè³‡è¨Šï¼ˆå¦‚æ“ä½œæˆåŠŸæç¤ºï¼‰ |

- --

## éŒ¯èª¤ç¢¼å®šç¾©

### HTTP éŒ¯èª¤ç¢¼

| HTTP ç‹€æ…‹ç¢¼ | éŒ¯èª¤ç¢¼ | èªªæ˜ | è™•ç†æ–¹å¼ |
|------------|--------|------|---------|
| 400 | `http.400.bad_request` | è«‹æ±‚åƒæ•¸éŒ¯èª¤ | æª¢æŸ¥è«‹æ±‚åƒæ•¸ |
| 401 | `http.401.unauthorized` | æœªæˆæ¬Š | é‡æ–°ç™»å…¥ |
| 403 | `http.403.forbidden` | ç„¡æ¬Šé™ | æª¢æŸ¥ç”¨æˆ¶æ¬Šé™ |
| 404 | `http.404.not_found` | è³‡æºä¸å­˜åœ¨ | æª¢æŸ¥è³‡æº ID |
| 409 | `http.409.conflict` | è³‡æ–™è¡çª | æª¢æŸ¥å”¯ä¸€æ€§ç´„æŸ |
| 500 | `http.500.internal_server_error` | ä¼ºæœå™¨éŒ¯èª¤ | è¯ç¹«ç®¡ç†å“¡ |
| 502 | `http.502.bad_gateway` | é–˜é“éŒ¯èª¤ | é‡è©¦è«‹æ±‚ |
| 503 | `http.503.service_unavailable` | æœå‹™ä¸å¯ç”¨ | ç¨å¾Œé‡è©¦ |

### ç¶²è·¯éŒ¯èª¤ç¢¼

| éŒ¯èª¤ç¢¼ | èªªæ˜ | è™•ç†æ–¹å¼ |
|--------|------|---------|
| `network.timeout` | è«‹æ±‚è¶…æ™‚ | é‡è©¦è«‹æ±‚ |
| `network.offline` | ç¶²è·¯é›¢ç·š | æª¢æŸ¥ç¶²è·¯é€£ç·š |
| `network.dns_failed` | DNS è§£æå¤±æ•— | æª¢æŸ¥ç¶²è·¯è¨­å®š |

### é©—è­‰éŒ¯èª¤ç¢¼

| éŒ¯èª¤ç¢¼ | èªªæ˜ | è™•ç†æ–¹å¼ |
|--------|------|---------|
| `validation.form.required` | å¿…å¡«æ¬„ä½ç‚ºç©º | å¡«å¯«å¿…å¡«æ¬„ä½ |
| `validation.form.email` | é›»å­éƒµä»¶æ ¼å¼éŒ¯èª¤ | ä¿®æ­£é›»å­éƒµä»¶æ ¼å¼ |
| `validation.form.min_length` | é•·åº¦ä¸è¶³ | å¢åŠ è¼¸å…¥é•·åº¦ |

### æ¥­å‹™éŒ¯èª¤ç¢¼

| éŒ¯èª¤ç¢¼ | èªªæ˜ | è™•ç†æ–¹å¼ |
|--------|------|---------|
| `business.task.limit_reached` | ä»»å‹™æ•¸é‡å·²é”ä¸Šé™ | åˆªé™¤èˆŠä»»å‹™æˆ–å‡ç´šæ–¹æ¡ˆ |
| `business.blueprint.not_found` | è—åœ–ä¸å­˜åœ¨ | æª¢æŸ¥è—åœ– ID |
| `business.user.inactive` | ç”¨æˆ¶æœªå•Ÿç”¨ | è¯ç¹«ç®¡ç†å“¡å•Ÿç”¨å¸³æˆ¶ |

### æ¬Šé™éŒ¯èª¤ç¢¼

| éŒ¯èª¤ç¢¼ | èªªæ˜ | è™•ç†æ–¹å¼ |
|--------|------|---------|
| `permission.denied` | ç„¡æ¬Šé™ | è¯ç¹«ç®¡ç†å“¡æˆäºˆæ¬Šé™ |
| `permission.role.insufficient` | è§’è‰²æ¬Šé™ä¸è¶³ | å‡ç´šè§’è‰²æ¬Šé™ |

### Git-like åˆ†æ”¯éŒ¯èª¤ç¢¼

| éŒ¯èª¤ç¢¼ | èªªæ˜ | è™•ç†æ–¹å¼ |
|--------|------|---------|
| `branch.merge.conflict` | åˆä½µæ‰¿æ”¬æ¬„ä½æ™‚è³‡æ–™è¡çª | ä¾éŒ¯èª¤ payload ä¿®æ­£æ¬„ä½å¾Œé‡æ–°æäº¤ PR |
| `branch.payload.missing` | PR ç¼ºå°‘å…è¨±æ¬„ä½ | ç¢ºèª `payload` åªåŒ…å«åœ¨ `allowed_columns` å…§çš„æ¬„ä½ |
| `branch.role.forbidden` | åˆ†æ”¯è§’è‰²ç„¡è©²æ¬„ä½å¯«å…¥æ¬Šé™ | èª¿æ•´ `branch_roles`/`branch_permissions` æˆ–è«‹æ“æœ‰è€…æ“ä½œ |
| `staging.expired` | æš«å­˜æäº¤é€¾æœŸ | é‡æ–°å¡«å¯«è³‡æ–™æˆ–é€é PR ä¿®æ­£ |

- --

## ä½¿ç”¨ ErrorStateService

### åŸºæœ¬ä½¿ç”¨

```typescript
import { inject } from '@angular/core';
import { ErrorStateService } from '@core/net';

export class MyService {
  private readonly errorService = inject(ErrorStateService);

  async performAction() {
    try {
      await someOperation();
    } catch (error) {
      this.errorService.addError({
        type: 'business',
        severity: 'error',
        message: 'æ“ä½œå¤±æ•—',
        details: error.message,
        source: 'MyService',
        retryable: false
      });
    }
  }
}
```

### è‡ªå‹• HTTP éŒ¯èª¤è™•ç†

æ‰€æœ‰ HTTP éŒ¯èª¤æœƒè‡ªå‹•è™•ç†ï¼Œç„¡éœ€æ‰‹å‹•æ·»åŠ ï¼š

```typescript
// HTTP éŒ¯èª¤æœƒè‡ªå‹•è¨˜éŒ„åˆ° ErrorStateService
this.http.get('/api/data').subscribe({
  next: (data) => console.log(data),
  error: (error) => {
    // éŒ¯èª¤å·²è¢«è‡ªå‹•è¨˜éŒ„ï¼Œé€™è£¡å¯ä»¥æ·»åŠ é¡å¤–è™•ç†
    console.error('è¼‰å…¥å¤±æ•—', error);
  }
});
```

### æ‰‹å‹•æ·»åŠ éŒ¯èª¤

```typescript
// ç¶²è·¯éŒ¯èª¤ï¼ˆå¯é‡è©¦ï¼‰
this.errorService.addError({
  type: 'network',
  severity: 'error',
  message: 'ç¶²è·¯é€£ç·šå¤±æ•—',
  details: 'ç„¡æ³•é€£æ¥åˆ°æœå‹™å™¨',
  source: 'DataService',
  retryable: true,
  retryFn: () => {
    this.loadData();
  }
});

// é©—è­‰éŒ¯èª¤
this.errorService.addError({
  type: 'validation',
  severity: 'warning',
  message: 'è¡¨å–®é©—è­‰å¤±æ•—',
  details: 'è«‹æª¢æŸ¥è¼¸å…¥æ¬„ä½',
  source: 'FormComponent',
  retryable: false
});

// æ¥­å‹™é‚è¼¯éŒ¯èª¤
this.errorService.addError({
  type: 'business',
  severity: 'error',
  message: 'é¤˜é¡ä¸è¶³',
  details: 'æ‚¨çš„å¸³æˆ¶é¤˜é¡ä¸è¶³ä»¥å®Œæˆæ­¤æ“ä½œ',
  source: 'PaymentService',
  retryable: false,
  metadata: {
    accountId: '123',
    amount: 1000,
    balance: 500
  }
});
```

- --

## å‰ç«¯éŒ¯èª¤é¡¯ç¤º

### ä½¿ç”¨ ErrorBannerComponent

åœ¨æ‡‰ç”¨æ ¹çµ„ä»¶ä¸­æ·»åŠ éŒ¯èª¤æ©«å¹…ï¼š

```typescript
import { Component, inject } from '@angular/core';
import { ErrorStateService } from '@core/net';
import { ErrorBannerComponent } from '@shared/components/error-display';

@Component({
  selector: 'app-root',
  standalone: true,
  imports: [ErrorBannerComponent, /* ... */],
  template: `
    <app-error-banner
      [errors]="errorService.activeErrors()"
      (clear)="errorService.removeError($event)"
      (retry)="errorService.retryError($event)"
    />
    <router-outlet />
  `
})
export class AppComponent {
  readonly errorService = inject(ErrorStateService);
}
```

### åœ¨çµ„ä»¶ä¸­é¡¯ç¤ºéŒ¯èª¤

```typescript
import { Component, inject } from '@angular/core';
import { ErrorStateService } from '@core/net';

@Component({
  selector: 'app-my-component',
  template: `
    @if (errorService.hasErrors()) {
      <div class="error-summary">
        ç™¼ç¾ {{ errorService.errorCount() }} å€‹éŒ¯èª¤
      </div>
    }

    @for (error of errorService.criticalErrors(); track error.id) {
      <div class="critical-error">
        {{ error.message }}
      </div>
    }
  `
})
export class MyComponent {
  readonly errorService = inject(ErrorStateService);
}
```

- --

## å¾Œç«¯éŒ¯èª¤å›æ‡‰

### Supabase PostgREST éŒ¯èª¤æ ¼å¼

```json
{
  "error": {
    "code": "PGRST116",
    "message": "The result contains 0 rows",
    "details": null,
    "hint": null
  }
}
```

### Edge Functions éŒ¯èª¤æ ¼å¼

```typescript
// æˆåŠŸå›æ‡‰
return new Response(
  JSON.stringify({ success: true, data: result }),
  { status: 200, headers: { 'Content-Type': 'application/json' } }
);

// éŒ¯èª¤å›æ‡‰
return new Response(
  JSON.stringify({
    error: {
      code: 'business.task.not_found',
      message: 'ä»»å‹™ä¸å­˜åœ¨',
      details: `æ‰¾ä¸åˆ° ID ç‚º ${taskId} çš„ä»»å‹™`
    }
  }),
  { status: 404, headers: { 'Content-Type': 'application/json' } }
);
```

**Git-like/æš«å­˜ Edge Functions**ï¼ˆå¦‚ `branch-merge`, `staging-finalize`ï¼‰è«‹å‹™å¿…ï¼š

- ä½¿ç”¨ä¸Šè¡¨å®šç¾©çš„éŒ¯èª¤ç¢¼ï¼ˆå¦‚ `branch.merge.conflict`, `staging.expired`ï¼‰ã€‚
- åœ¨ `details` ä¸­é™„ä¸Šè¡çªæ¬„ä½æˆ–é€¾æœŸæ™‚é–“ï¼Œæ–¹ä¾¿å‰ç«¯é¡¯ç¤ºã€‚
- ä½¿ç”¨å°æ‡‰çš„ HTTP ç‹€æ…‹ç¢¼ï¼š`409`ï¼ˆè¡çªï¼‰ã€`422`ï¼ˆpayload ä¸å®Œæ•´ï¼‰ã€`410`ï¼ˆæš«å­˜é€¾æœŸï¼‰ã€‚

- --

## éŒ¯èª¤æ—¥èªŒè¨˜éŒ„

### å‰ç«¯éŒ¯èª¤æ—¥èªŒ

éŒ¯èª¤æœƒè‡ªå‹•è¨˜éŒ„åˆ° `ErrorStateService` çš„éŒ¯èª¤æ­·å²ä¸­ï¼š

```typescript
// ç²å–éŒ¯èª¤æ­·å²
const history = this.errorService.errorHistory();

// æŸ¥çœ‹æœ€è¿‘çš„éŒ¯èª¤
const recentErrors = history
  .slice(-10)
  .sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
```

### å¾Œç«¯éŒ¯èª¤æ—¥èªŒ

ä½¿ç”¨ Supabase çš„æ—¥èªŒåŠŸèƒ½ï¼š

```bash
# ä½¿ç”¨ Supabase MCP å·¥å…·æŸ¥çœ‹æ—¥èªŒ
@SUPABASE ç²å– API æ—¥èªŒ
@SUPABASE ç²å– Edge Functions æ—¥èªŒ
```

### éŒ¯èª¤è¿½è¹¤

å»ºè­°æ•´åˆéŒ¯èª¤è¿½è¹¤æœå‹™ï¼ˆå¦‚ Sentryï¼‰ï¼š

```typescript
// åœ¨ ErrorStateService ä¸­æ·»åŠ éŒ¯èª¤è¿½è¹¤
this.errorService.addError({
  // ...
  metadata: {
    // æ·»åŠ è¿½è¹¤è³‡è¨Š
    userId: this.userService.currentUser()?.id,
    url: window.location.href,
    userAgent: navigator.userAgent
  }
});
```

- --

## æœ€ä½³å¯¦è¸

### 1. éŒ¯èª¤åˆ†é¡åŸå‰‡

- **HTTP éŒ¯èª¤**ï¼šç¶²è·¯è«‹æ±‚ç›¸é—œçš„éŒ¯èª¤ï¼ˆè‡ªå‹•è™•ç†ï¼‰
- **ç¶²è·¯éŒ¯èª¤**ï¼šé€£ç·šå¤±æ•—ã€è¶…æ™‚ç­‰
- **é©—è­‰éŒ¯èª¤**ï¼šè¡¨å–®é©—è­‰ã€è¼¸å…¥é©—è­‰éŒ¯èª¤
- **æ¥­å‹™é‚è¼¯éŒ¯èª¤**ï¼šæ¥­å‹™è¦å‰‡é•åã€æ“ä½œå¤±æ•—
- **æ¬Šé™éŒ¯èª¤**ï¼šç„¡æ¬Šé™è¨ªå•ã€èº«ä»½é©—è­‰å¤±æ•—

### 2. åš´é‡ç¨‹åº¦é¸æ“‡

- **critical**ï¼šç³»çµ±ç´šéŒ¯èª¤ï¼Œéœ€è¦ç«‹å³è™•ç†
- **error**ï¼šä¸€èˆ¬éŒ¯èª¤ï¼Œéœ€è¦è™•ç†
- **warning**ï¼šè­¦å‘Šï¼Œå¯å¿½ç•¥
- **info**ï¼šè³‡è¨Šæç¤º

### 3. éŒ¯èª¤è¨Šæ¯æ’°å¯«

```typescript
// âœ… å¥½çš„éŒ¯èª¤è¨Šæ¯
{
  message: 'ç„¡æ³•è¼‰å…¥ç”¨æˆ¶è³‡æ–™',
  details: 'ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯è¨­å®š'
}

// âŒ ä¸å¥½çš„éŒ¯èª¤è¨Šæ¯
{
  message: 'Error',
  details: 'Something went wrong'
}
```

### 4. éŒ¯èª¤ä¾†æºæ¨™è¨˜

å§‹çµ‚æä¾› `source` åƒæ•¸ï¼Œæ–¹ä¾¿è¿½è¹¤éŒ¯èª¤ä¾†æºï¼š

```typescript
this.errorService.addError({
  // ...
  source: 'UserService.loadUserProfile', // æ¸…æ™°çš„ä¾†æºæ¨™è¨˜
});
```

### 5. éŒ¯èª¤å…ƒæ•¸æ“š

ä½¿ç”¨ `metadata` å„²å­˜æœ‰ç”¨çš„èª¿è©¦è³‡è¨Šï¼š

```typescript
this.errorService.addError({
  // ...
  metadata: {
    userId: '123',
    operation: 'updateProfile',
    requestData: { name: 'John' }
  }
});
```

### 6. é¿å…é‡è¤‡éŒ¯èª¤

åœ¨æ·»åŠ éŒ¯èª¤å‰æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒéŒ¯èª¤ï¼š

```typescript
const existingError = this.errorService
  .activeErrors()
  .find(e => e.message === 'ç¶²è·¯é€£ç·šå¤±æ•—');

if (!existingError) {
  this.errorService.addError({
    // ...
  });
}
```

### 7. éŒ¯èª¤é‡è©¦

å°å¯æ¢å¾©çš„éŒ¯èª¤æä¾›é‡è©¦æ©Ÿåˆ¶ï¼š

```typescript
this.errorService.addError({
  type: 'network',
  severity: 'error',
  message: 'ç¶²è·¯é€£ç·šå¤±æ•—',
  retryable: true,
  retryFn: () => {
    this.loadData();
  }
});
```

- --

## å®Œæ•´ç¯„ä¾‹

### ç¯„ä¾‹ 1ï¼šæœå‹™ä¸­çš„éŒ¯èª¤è™•ç†

```typescript
import { Injectable, inject } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { ErrorStateService } from '@core/net';
import { catchError, throwError } from 'rxjs';

@Injectable({ providedIn: 'root' })
export class UserService {
  private readonly http = inject(HttpClient);
  private readonly errorService = inject(ErrorStateService);

  loadUser(userId: string) {
    return this.http.get(`/api/users/${userId}`).pipe(
      catchError(error => {
        // HTTP éŒ¯èª¤æœƒè¢«è‡ªå‹•è¨˜éŒ„ï¼Œä½†å¯ä»¥æ·»åŠ é¡å¤–çš„æ¥­å‹™é‚è¼¯
        if (error.status === 404) {
          this.errorService.addError({
            type: 'business',
            severity: 'error',
            message: 'ç”¨æˆ¶ä¸å­˜åœ¨',
            details: `æ‰¾ä¸åˆ° ID ç‚º ${userId} çš„ç”¨æˆ¶`,
            source: 'UserService.loadUser',
            retryable: false,
            metadata: { userId }
          });
        }
        return throwError(() => error);
      })
    );
  }
}
```

### ç¯„ä¾‹ 2ï¼šçµ„ä»¶ä¸­çš„éŒ¯èª¤è™•ç†

```typescript
import { Component, inject, signal } from '@angular/core';
import { ErrorStateService } from '@core/net';
import { ErrorBannerComponent } from '@shared/components/error-display';
import { UserService } from './user.service';

@Component({
  selector: 'app-user-profile',
  standalone: true,
  imports: [ErrorBannerComponent],
  template: `
    <app-error-banner
      [errors]="errorService.activeErrors()"
      (clear)="errorService.removeError($event)"
      (retry)="errorService.retryError($event)"
    />

    @if (user(); as userData) {
      <div class="user-profile">
        <h1>{{ userData.name }}</h1>
        <p>{{ userData.email }}</p>
      </div>
    }

    @if (errorService.hasErrors()) {
      <div class="error-summary">
        ç™¼ç¾ {{ errorService.errorCount() }} å€‹éŒ¯èª¤
      </div>
    }
  `
})
export class UserProfileComponent {
  readonly userService = inject(UserService);
  readonly errorService = inject(ErrorStateService);
  readonly user = signal<any>(null);

  ngOnInit() {
    this.loadUser();
  }

  loadUser() {
    this.userService.loadUser('123').subscribe({
      next: (user) => this.user.set(user),
      error: (error) => {
        // éŒ¯èª¤å·²è¢«è‡ªå‹•è¨˜éŒ„
        console.error('è¼‰å…¥ç”¨æˆ¶å¤±æ•—', error);
      }
    });
  }
}
```

### ç¯„ä¾‹ 3ï¼šè¡¨å–®é©—è­‰éŒ¯èª¤

```typescript
import { Component, inject } from '@angular/core';
import { FormBuilder, Validators } from '@angular/forms';
import { ErrorStateService } from '@core/net';

@Component({
  selector: 'app-contact-form',
  standalone: true,
  template: `
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <input formControlName="email" type="email" />
      @if (form.get('email')?.invalid && form.get('email')?.touched) {
        <span class="error">è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€</span>
      }
      <button type="submit" [disabled]="form.invalid">æäº¤</button>
    </form>
  `
})
export class ContactFormComponent {
  private readonly fb = inject(FormBuilder);
  private readonly errorService = inject(ErrorStateService);

  form = this.fb.group({
    email: ['', [Validators.required, Validators.email]]
  });

  onSubmit() {
    if (this.form.invalid) {
      this.errorService.addError({
        type: 'validation',
        severity: 'warning',
        message: 'è¡¨å–®é©—è­‰å¤±æ•—',
        details: 'è«‹æª¢æŸ¥æ‰€æœ‰å¿…å¡«æ¬„ä½',
        source: 'ContactFormComponent',
        retryable: false
      });
      return;
    }
    // æäº¤è¡¨å–®...
  }
}
```

- --

## API åƒè€ƒ

### ErrorStateService æ–¹æ³•

| æ–¹æ³• | èªªæ˜ | åƒæ•¸ | è¿”å›å€¼ |
|------|------|------|--------|
| `addError(error)` | æ·»åŠ éŒ¯èª¤ | `ErrorRecord` | `string` (éŒ¯èª¤ ID) |
| `removeError(id)` | ç§»é™¤éŒ¯èª¤ | `string` (éŒ¯èª¤ ID) | `void` |
| `clearErrors()` | æ¸…é™¤æ‰€æœ‰éŒ¯èª¤ | - | `void` |
| `clearErrorsByType(type)` | æ¸…é™¤ç‰¹å®šé¡å‹çš„éŒ¯èª¤ | `ErrorType` | `void` |
| `clearErrorsBySeverity(severity)` | æ¸…é™¤ç‰¹å®šåš´é‡ç¨‹åº¦çš„éŒ¯èª¤ | `ErrorSeverity` | `void` |
| `retryError(id)` | é‡è©¦éŒ¯èª¤ | `string` (éŒ¯èª¤ ID) | `void` |
| `getError(id)` | ç²å–ç‰¹å®šéŒ¯èª¤ | `string` (éŒ¯èª¤ ID) | `ErrorRecord \| undefined` |
| `filterErrors(predicate)` | éæ¿¾éŒ¯èª¤ | `(error: ErrorRecord) => boolean` | `ErrorRecord[]` |
| `clearHistory()` | æ¸…é™¤æ­·å²è¨˜éŒ„ | - | `void` |

### ErrorStateService å±¬æ€§ï¼ˆSignalï¼‰

| å±¬æ€§ | èªªæ˜ | é¡å‹ |
|------|------|------|
| `errors` | æ‰€æœ‰éŒ¯èª¤åˆ—è¡¨ | `Signal<ErrorRecord[]>` |
| `errorHistory` | éŒ¯èª¤æ­·å²è¨˜éŒ„ | `Signal<ErrorRecord[]>` |
| `activeErrors` | ç•¶å‰æ´»èºçš„éŒ¯èª¤ | `Signal<ErrorRecord[]>` |
| `hasErrors` | æ˜¯å¦æœ‰éŒ¯èª¤ | `Signal<boolean>` |
| `errorCount` | éŒ¯èª¤æ•¸é‡ | `Signal<number>` |
| `criticalErrors` | åš´é‡éŒ¯èª¤åˆ—è¡¨ | `Signal<ErrorRecord[]>` |
| `normalErrors` | ä¸€èˆ¬éŒ¯èª¤åˆ—è¡¨ | `Signal<ErrorRecord[]>` |

- --

## ç›¸é—œæ–‡æª”

- [é–‹ç™¼ä½œæ¥­æŒ‡å¼•](./specs/00-development-guidelines.md)
- [APIæ¥å£è©³ç´°æ–‡æª”](./33-API-æ¥å£è©³ç´°æ–‡æª”.md)
- [å¸¸è¦‹å•é¡Œ FAQ](./36-å¸¸è¦‹å•é¡Œ-FAQ.md)
- `src/app/core/net/error/ERROR_HANDLING_GUIDE.md`

- --

**æœ€å¾Œæ›´æ–°**ï¼š2025-11-13
**ç¶­è­·è€…**ï¼šé–‹ç™¼åœ˜éšŠ


