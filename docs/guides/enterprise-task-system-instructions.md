# 企業級任務系統開發指令


> **📚 目的**: 提供企業級任務系統的開發規範與架構指引

## 目標讀者 (Audience)

- 前端開發者
- 後端開發者
- 架構師

---


## 📑 目錄

- [🎯 快速導覽](#-快速導覽)
  - [我該如何開始？](#我該如何開始)
- [📚 文檔清單](#-文檔清單)
  - [優先級最高：必讀核心文檔](#優先級最高必讀核心文檔)
    - [架構設計文檔](#架構設計文檔)
    - [資料庫與資料模型](#資料庫與資料模型)
    - [業務流程與狀態](#業務流程與狀態)
  - [優先級高：重要參考文檔](#優先級高重要參考文檔)
    - [開發規範](#開發規範)
    - [相關系統文檔](#相關系統文檔)
  - [優先級中：輔助參考文檔（按需查閱）](#優先級中輔助參考文檔按需查閱)
- [📖 閱讀順序](#-閱讀順序)
  - [步驟 1：先讀架構文檔](#步驟-1先讀架構文檔)
  - [步驟 2：再讀資料庫結構](#步驟-2再讀資料庫結構)
  - [步驟 3：然後了解業務流程](#步驟-3然後了解業務流程)
  - [步驟 4：最後了解開發規範](#步驟-4最後了解開發規範)
- [🗄️ 任務系統](#-任務系統)
  - [核心表（9 張表）](#核心表9-張表)
    - [1. `tasks`](#1-tasks)
    - [2. `task_assignments`](#2-task_assignments)
    - [3. `task_lists`](#3-task_lists)
    - [4. `task_staging`](#4-task_staging)
    - [5. `daily_reports`](#5-daily_reports)
    - [6. `report_photos`](#6-report_photos)
    - [7. `task_dependencies`](#7-task_dependencies)
    - [8. `task_templates`](#8-task_templates)
    - [9. `weather_cache`](#9-weather_cache)
  - [待辦中心相關表（2 張表）](#待辦中心相關表2-張表)
    - [1. `personal_todos`](#1-personal_todos)
    - [2. `todo_status_tracking`](#2-todo_status_tracking)
  - [狀態流轉](#狀態流轉)
    - [總狀態數：8 種](#總狀態數8-種)
    - [狀態流轉流程](#狀態流轉流程)
    - [取消規則](#取消規則)
    - [關鍵節點](#關鍵節點)
- [🛠️ 工具（核心方法）](#-工具核心方法)
  - [核心工具](#核心工具)
    - [`@S7` - Sequential Thinking ⭐⭐⭐⭐⭐](#s7---sequential-thinking-)
    - [`@SPT` - Software Planning Tool ⭐⭐⭐⭐⭐](#spt---software-planning-tool-)
  - [輔助工具](#輔助工具)
    - [`@C7` - Context7 ⭐⭐⭐⭐](#c7---context7-)
    - [`@SC7` / `@SSC7` - Context7 + Sequential Thinking ⭐⭐⭐⭐](#sc7--ssc7---context7--sequential-thinking-)
    - [`@SUPABASE` - Supabase MCP ⭐⭐⭐⭐](#supabase---supabase-mcp-)
  - [工具使用指引矩陣](#工具使用指引矩陣)
  - [工具組合最佳實踐](#工具組合最佳實踐)
    - [組合 1: 標準開發（Level 3-5）](#組合-1-標準開發level-3-5)
    - [組合 2: 技術調研（新技術/新功能）](#組合-2-技術調研新技術新功能)
    - [組合 3: 跨模組重構（Level 6-8）](#組合-3-跨模組重構level-6-8)
    - [組合 4: 資料庫變更](#組合-4-資料庫變更)
    - [組合 5: 緊急問題修復（複雜 Bug）](#組合-5-緊急問題修復複雜-bug)
  - [使用指引](#使用指引)
- [🔄 開發流程](#-開發流程)
  - [步驟 1：建立思考框架（最重要）](#步驟-1建立思考框架最重要)
    - [1.1 首要參考：系統架構思維導圖](#11-首要參考系統架構思維導圖)
    - [1.2 使用 Sequential Thinking (@S7) 進行任務分析](#12-使用-sequential-thinking-s7-進行任務分析)
    - [1.3 使用 Software Planning Tool (@SPT) 進行任務拆解](#13-使用-software-planning-tool-spt-進行任務拆解)
    - [1.4 @S7 與 @SPT 整合工作流](#14-s7-與-spt-整合工作流)
    - [1.5 企業標準檢查點](#15-企業標準檢查點)
  - [步驟 2：開發推進](#步驟-2開發推進)
    - [2.1 將大任務分解為子任務](#21-將大任務分解為子任務)
    - [2.2 為每個子任務設置優先級與預估時間](#22-為每個子任務設置優先級與預估時間)
    - [2.3 使用 Sequential Thinking 分析任務順序](#23-使用-sequential-thinking-分析任務順序)
    - [2.4 如有需要，調用 Context7 或 Supabase MCP 協作](#24-如有需要調用-context7-或-supabase-mcp-協作)
    - [2.5 完成任務後，執行 build 或專案對應 build 指令](#25-完成任務後執行-build-或專案對應-build-指令)
    - [2.6 記錄錯誤資訊](#26-記錄錯誤資訊)
- [⚠️ 錯誤處理](#-錯誤處理)
  - [步驟 1：執行構建](#步驟-1執行構建)
  - [步驟 2：記錄錯誤資訊](#步驟-2記錄錯誤資訊)
  - [步驟 3：根據錯誤類型採取對應措施](#步驟-3根據錯誤類型採取對應措施)
  - [步驟 4：驗證修復](#步驟-4驗證修復)
- [🎯 思考框架實戰範例](#-思考框架實戰範例)
  - [範例 1: Level 1-2 簡單任務（修復 UI Bug）](#範例-1-level-1-2-簡單任務修復-ui-bug)
  - [範例 2: Level 3-5 中等任務（新增功能）](#範例-2-level-3-5-中等任務新增功能)
  - [範例 3: Level 6-8 複雜任務（跨模組重構）](#範例-3-level-6-8-複雜任務跨模組重構)
  - [範例 4: 決策樹 - 何時使用哪個工具](#範例-4-決策樹---何時使用哪個工具)
  - [範例 5: 工具組合使用模式](#範例-5-工具組合使用模式)
- [✅ 驗證清單](#-驗證清單)
  - [提交前必須通過](#提交前必須通過)
  - [關鍵檢查項](#關鍵檢查項)
- [💻 命令](#-命令)
  - [開發命令](#開發命令)
  - [檢查命令](#檢查命令)
  - [修復命令](#修復命令)
- [🏗️ 技術棧](#-技術棧)
  - [版本要求](#版本要求)
  - [關鍵特性](#關鍵特性)
- [🏛️ 架構](#-架構)
  - [系統架構總覽](#系統架構總覽)
    - [11 個核心模組（51 張表）](#11-個核心模組51-張表)
  - [任務系統在整體架構中的位置](#任務系統在整體架構中的位置)
  - [Git-like 分支模型](#git-like-分支模型)
    - [主分支 (`blueprints`)](#主分支-blueprints)
    - [組織分支 (`blueprint_branches`)](#組織分支-blueprint_branches)
    - [Pull Request](#pull-request)
  - [資料庫](#資料庫)
  - [核心設計原則](#核心設計原則)
- [📝 注意事項](#-注意事項)
  - [重要提醒](#重要提醒)
  - [禁止事項](#禁止事項)
- [📝 版本歷史](#-版本歷史)
  - [v2.0 (2025-11-16) - 思考框架強化版](#v20-2025-11-16---思考框架強化版)
  - [v1.0 (2025-01-15) - 初始版本](#v10-2025-01-15---初始版本)
- [📚 相關文檔](#-相關文檔)
  - [必讀文檔（按閱讀順序）](#必讀文檔按閱讀順序)
  - [參考文檔](#參考文檔)
- [💬 意見回饋](#-意見回饋)

---


**版本**: 2.0
**最後更新**: 2025-11-16
**描述**: 完整的任務系統開發指引，以 Sequential Thinking 與 Software Planning Tool 為核心方法，包含文檔清單、工具使用、開發流程和驗證清單

> ⚠️ **首要參考**: 在開始任何開發任務前，必須先閱讀 [`docs/10-系統架構思維導圖.mermaid.md`](./10-系統架構思維導圖.mermaid.md) 以了解完整系統架構（11 個模組、51 張表）

> 💡 **核心方法**: 本指令以 **Sequential Thinking (@S7)** 與 **Software Planning Tool (@SPT)** 為核心方法論，確保任務分析、拆解與優先級排序達到企業標準

- --

## 🎯 快速導覽

### 我該如何開始？

**Step 1**: 閱讀 [`docs/10-系統架構思維導圖.mermaid.md`](./10-系統架構思維導圖.mermaid.md)（5 分鐘）
**Step 2**: 根據任務複雜度選擇流程：
- **Level 1-2**: 直接開發 → 跳至 [命令](#-命令) 章節
- **Level 3+**: 使用思考框架 → 跳至 [開發流程](#-開發流程) 章節

**Step 3**: 查看實戰範例 → 跳至 [思考框架實戰範例](#-思考框架實戰範例) 章節

- --

## 📚 文檔清單

### 優先級最高：必讀核心文檔

#### 架構設計文檔

##### `docs/27-完整架構流程圖.mermaid.md`
- **描述**: 完整架構流程（Git-like 分支模型、任務執行流程、待辦中心）
- **關鍵點**:
  - Git-like 分支模型
  - 任務執行流程
  - 待辦中心機制

##### `docs/28-架構審查報告.md`
- **描述**: 架構決策與設計原則
- **關鍵點**:
  - 架構決策
  - 設計原則
  - 最佳實踐

##### `docs/30-0-完整SQL表結構定義.md`
- **描述**: 51 張表的完整 SQL 定義
- **關鍵點**:
  - 任務相關表在第 469-703 行
  - 51 張資料表完整定義
  - 資料庫結構規範

#### 資料庫與資料模型

##### `docs/30-資料表清單總覽.md`
- **描述**: 51 張表清單（任務執行系統 9 張表）
- **關鍵點**:
  - 任務執行系統 9 張表
  - 資料表分類統計
  - 關鍵關聯關係

##### `docs/34-資料模型對照表.md`
- **描述**: 資料庫與 TypeScript 模型對照
- **關鍵點**:
  - 資料庫與 TypeScript 對照
  - 模型定義規範
  - 類型安全

#### 業務流程與狀態

##### `docs/14-業務流程圖.mermaid.md`
- **描述**: 任務執行、暫存、品管、驗收流程
- **關鍵點**:
  - 任務執行流程
  - 暫存區機制
  - 品管驗收流程

##### `docs/16-狀態圖.mermaid.md`
- **描述**: 任務狀態流轉圖
- **關鍵點**:
  - 狀態流轉規則
  - 狀態轉換條件
  - 狀態圖視覺化

##### `docs/43-狀態枚舉值定義.md`
- **描述**: 任務狀態定義（8 種狀態）
- **關鍵點**:
  - 8 種任務狀態
  - 狀態枚舉值
  - TypeScript 類型定義

### 優先級高：重要參考文檔

#### 開發規範

- `docs/00-開發作業指引.md` - 開發規範與流程
- `docs/35-開發工作流程.md` - 開發工作流程
- `docs/45-SHARED_IMPORTS-使用指南.md` - 共享模組使用規範

#### 相關系統文檔

- `docs/12-實體關係圖.mermaid.md` - 資料庫 ER 圖
- `docs/13-帳戶層流程圖.mermaid.md` - 帳戶層架構（任務指派涉及帳戶）
- `docs/21-安全與-RLS-權限矩陣.md` - 權限控制（任務權限）

### 優先級中：輔助參考文檔（按需查閱）

- `docs/33-API-接口詳細文檔.md` - API 接口定義
- `docs/37-錯誤處理指南.md` - 錯誤處理規範
- `docs/42-詞彙表.md` - 術語說明

- --

## 📖 閱讀順序

### 步驟 1：先讀架構文檔
**目的**: 了解整體架構

- `docs/27-完整架構流程圖.mermaid.md`
- `docs/28-架構審查報告.md`

### 步驟 2：再讀資料庫結構
**目的**: 了解任務相關表結構（第 469-703 行）

- `docs/30-0-完整SQL表結構定義.md`

### 步驟 3：然後了解業務流程
**目的**: 了解業務流程

- `docs/14-業務流程圖.mermaid.md`
- `docs/16-狀態圖.mermaid.md`

### 步驟 4：最後了解開發規範
**目的**: 了解開發規範

- `docs/00-開發作業指引.md`
- `docs/45-SHARED_IMPORTS-使用指南.md`

- --

## 🗄️ 任務系統

### 核心表（9 張表）

任務執行系統包含 9 張表：

#### 1. `tasks`
- **描述**: 任務主表（樹狀結構，無層級限制）
- **關鍵欄位**:
  - `id`
  - `blueprint_id`
  - `branch_id`
  - `parent_task_id`
  - `status`
  - `contractor_fields`

#### 2. `task_assignments`
- **描述**: 任務指派表（個人/團隊/組織/承攬）
- **關鍵欄位**:
  - `task_id`
  - `assignee_type`
  - `assignee_id`

#### 3. `task_lists`
- **描述**: 任務列表表（按指派對象分類）
- **關鍵欄位**:
  - `task_id`
  - `assignee_id`
  - `status`

#### 4. `task_staging`
- **描述**: 暫存區表（48 小時可撤回）
- **關鍵欄位**:
  - `task_id`
  - `staging_data`
  - `expires_at`
  - `can_withdraw`

#### 5. `daily_reports`
- **描述**: 施工日誌表（自動同步到主分支）
- **關鍵欄位**:
  - `task_id`
  - `report_date`
  - `work_content`

#### 6. `report_photos`
- **描述**: 報表照片表
- **關鍵欄位**:
  - `daily_report_id`
  - `photo_url`

#### 7. `task_dependencies`
- **描述**: 任務依賴關係表
- **關鍵欄位**:
  - `task_id`
  - `depends_on_task_id`

#### 8. `task_templates`
- **描述**: 任務模板表
- **關鍵欄位**:
  - `template_name`
  - `template_data`

#### 9. `weather_cache`
- **描述**: 天氣快取表
- **關鍵欄位**:
  - `location`
  - `date`
  - `weather_data`

### 待辦中心相關表（2 張表）

#### 1. `personal_todos`
- **描述**: 個人待辦中心表（五種狀態分類）

**狀態分類**:

| 狀態 | 圖示 | 名稱 | 來源 | 備註 |
|------|------|------|------|------|
| `pending` | 🟦 | 待執行 | `task_lists` | - |
| `staging` | 🟨 | 暫存中 | `task_staging` | 48 小時可撤回 |
| `in_qa` | 🟧 | 品管中 | `quality_checks` | - |
| `in_inspection` | 🟥 | 驗收中 | `inspections` | - |
| `open/in_progress` | ⚠️ | 問題追蹤 | `issues` | - |

#### 2. `todo_status_tracking`
- **描述**: 待辦狀態追蹤表
- **關鍵欄位**:
  - `todo_id`
  - `status`
  - `changed_at`

### 狀態流轉

#### 總狀態數：8 種

| 狀態值 | 名稱 | 描述 | 特殊說明 |
|--------|------|------|----------|
| `pending` | 待處理 | 任務已建立但未開始 | - |
| `assigned` | 已指派 | 任務已指派給負責人 | - |
| `in_progress` | 進行中 | 任務正在執行 | - |
| `staging` | 暫存中 | 任務已提交，進入 48 小時暫存區 | **48 小時可撤回機制** |
| `in_qa` | 品管中 | 任務進入品質檢查流程 | - |
| `in_inspection` | 驗收中 | 任務進入驗收流程 | **驗收通過後責任轉移** |
| `completed` | 已完成 | 任務已完成 | - |
| `cancelled` | 已取消 | 任務已取消 | - |

#### 狀態流轉流程

```text
```

#### 取消規則

可在任何階段取消（`pending`/`assigned`/`in_progress`/`staging`）

#### 關鍵節點

1. **`staging`**: 暫存區，48 小時可撤回機制
2. **`in_inspection`**: 驗收通過後責任轉移

- --

## 🛠️ 工具（核心方法）

> ⚠️ **重要**: Sequential Thinking (@S7) 與 Software Planning Tool (@SPT) 是企業級任務開發的核心方法論

### 核心工具

#### `@S7` - Sequential Thinking ⭐⭐⭐⭐⭐

- **全名**: Sequential Thinking
- **類型**: 思考分析工具
- **描述**: 複雜問題的系統性分析與拆解，企業級任務開發的基石
- **適用場景**:
  - ✅ Level 3+ 複雜任務（必須）
  - ✅ 架構設計決策
  - ✅ 根因分析
  - ✅ 技術方案選型
  - ✅ 風險評估
  - ✅ 跨模組依賴分析

**使用方式**:
1. 在任務開始前呼叫 @S7
```text
3. 包含必要的上下文資訊
4. 遵循 5 步驟思考流程：
   - 問題定義
   - 現狀分析
   - 方案探索
   - 依賴分析
   - 風險評估
```

**輸出格式**:
- 結構化分析報告
- 多方案比較
- 推薦方案與理由
- 風險與緩解措施

**範例**:
@S7 請分析「為任務新增標籤功能」的最佳實作方案

```text
1. 資料庫設計（JSONB vs 關聯表 vs 陣列）
2. 對現有 API 的影響
3. UI/UX 設計方向
4. 效能影響
5. 安全性考量
```

- --

#### `@SPT` - Software Planning Tool ⭐⭐⭐⭐⭐

- **全名**: Software Planning Tool
- **類型**: 任務規劃與追蹤工具
- **描述**: 任務規劃、分解與進度追蹤，將思考轉化為可執行行動
- **適用場景**:
  - ✅ Level 3+ 複雜任務（必須）
  - ✅ 多步驟執行任務
  - ✅ 需要進度追蹤的長期任務
  - ✅ 團隊協作的大型功能

**使用方式**:
1. 在 @S7 分析後呼叫 @SPT
2. 設定任務目標（goal）
3. 拆解為可執行子任務
```text
   - 標題（title）
   - 詳細描述（description）
   - 複雜度（complexity: 0-10）
   - 可選：程式碼範例（codeExample）
5. 執行過程中更新狀態
```

**輸出格式**:
- 結構化任務清單
- 每個任務包含：ID、標題、描述、複雜度、狀態
- 可追蹤進度

**範例**:
@SPT 請為「實作任務標籤功能」建立實施計畫

根據 @S7 的分析結果，請拆解為：
1. 資料庫 schema 設計與 migration
```text
3. 前端 service 層
4. UI 組件開發
5. 測試與驗證

請為每個子任務設定複雜度與預估時間
```

- --

### 輔助工具

#### `@C7` - Context7 ⭐⭐⭐⭐

- **全名**: Context7
- **類型**: 技術文檔查詢工具
- **描述**: 獲取 Angular 20/ng-alain 最新信息和最佳實踐
- **適用場景**:
  - ✅ 技術決策前查詢官方文檔
  - ✅ 框架版本更新
  - ✅ 最佳實踐查詢
  - ✅ API 使用方法確認

**使用時機**:
- **必須**: 任何技術決策或修改前
- 不確定 API 使用方式時
- 需要查詢框架最佳實踐時
- 版本更新後確認 breaking changes

**範例**:
@C7 Angular 20 中 Signals 的最佳實踐
@C7 ng-zorro 表單驗證的標準寫法
@C7 ChangeDetectionStrategy.OnPush 的使用注意事項


```text
```

- --

#### `@SC7` / `@SSC7` - Context7 + Sequential Thinking ⭐⭐⭐⭐

- **全名**: Context7 + Sequential Thinking（組合工具）
- **類型**: 跨模組分析工具
- **描述**: 結合技術查詢與系統性思考，用於跨模組依賴分析
- **適用場景**:
  - ✅ 跨模組重構（必須）
  - ✅ 共用 Service 調整
  - ✅ 資料模型變更影響多模組
  - ✅ 核心架構變更

**使用時機**:
- 變更影響 3 個以上模組
- 修改共享服務或組件
- 資料庫 schema 變更波及多表
- 重構核心業務邏輯

**範例**:
@SC7 請分析「將認證服務改為使用 Supabase Auth」的影響範圍

需要考慮：
```text
2. 需要修改哪些組件/服務？
3. 資料庫變更需求
4. 向後相容性
5. 移轉策略
```

- --

#### `@SUPABASE` - Supabase MCP ⭐⭐⭐⭐

- **全名**: Supabase MCP
- **類型**: 資料庫操作工具
- **描述**: 資料庫操作與 RLS 驗證，所有資料庫操作必須透過此工具
- **適用場景**:
  - ✅ 資料庫查詢（必須）
  - ✅ RLS 策略驗證（必須）
  - ✅ 資料表結構檢查（必須）
  - ✅ Migration 驗證（必須）

**使用時機**:
- **必須**: 所有資料庫操作
- 檢查資料表 schema
- 驗證 RLS 策略正確性
- 測試資料庫查詢
- 執行 migration

**範例**:
@SUPABASE 檢查 tasks 表的 RLS 策略
@SUPABASE 查詢 personal_todos 表的 schema
@SUPABASE 驗證 task_staging 表的外鍵關係

```text
```

- --

### 工具使用指引矩陣

| 任務複雜度 | Level 1-2 | Level 3-5 | Level 6-8 | Level 9-10 |
|-----------|----------|----------|----------|-----------|
| **@S7** | 可選 | ✅ 必須 | ✅ 必須 | ✅ 必須 |
| **@SPT** | ❌ 不需要 | ✅ 必須 | ✅ 必須 | ✅ 必須 |
| **@C7** | 按需 | 建議 | 建議 | ✅ 必須 |
| **@SC7/@SSC7** | ❌ 不適用 | 按需 | 建議 | ✅ 必須 |
| **@SUPABASE** | 如有 DB 操作 | 如有 DB 操作 | 如有 DB 操作 | 如有 DB 操作 |

**說明**:
- **Level 1-2**: 簡單任務，直接開發
- **Level 3-5**: 中等任務，需要 @S7 分析 + @SPT 規劃
- **Level 6-8**: 複雜任務，需要完整工具鏈 + 跨模組分析
- **Level 9-10**: 非常複雜任務，需要所有工具 + 團隊協作

- --

### 工具組合最佳實踐

#### 組合 1: 標準開發（Level 3-5）
步驟 1: @S7 分析問題
步驟 2: @SPT 規劃任務
步驟 3: 開發實作
```text
```

#### 組合 2: 技術調研（新技術/新功能）
步驟 1: @C7 查詢文檔
步驟 2: @S7 評估方案
步驟 3: @SPT 規劃 POC
步驟 4: 開發驗證
```text
```

#### 組合 3: 跨模組重構（Level 6-8）
步驟 1: @SC7/@SSC7 依賴分析
步驟 2: @S7 風險評估
步驟 3: @SPT 階段規劃
步驟 4: 分階段開發
```text
```

#### 組合 4: 資料庫變更
步驟 1: @SUPABASE 檢查 schema
步驟 2: @S7 影響分析
步驟 3: @SPT migration 規劃
步驟 4: 開發與測試
```text
```

#### 組合 5: 緊急問題修復（複雜 Bug）
步驟 1: @S7 根因分析
步驟 2: @SUPABASE 資料驗證（如需要）
步驟 3: @SPT 修復規劃（如複雜）
步驟 4: 快速修復
```text
```

- --

### 使用指引

- **Level 1-2**: 直接開發
- **Level 3+**: 必須使用 `@S7` + `@SPT` 進行規劃
- **跨模組**: 使用 `@SC7` 或 `@SSC7` 進行依賴分析

- --

## 🔄 開發流程

### 步驟 1：建立思考框架（最重要）

> ⚠️ **必讀**: 這是任務開發的基礎步驟，必須嚴格執行以確保達到企業標準

**描述**: 啟用 Sequential Thinking 與 Software Planning Tool 作為任務分析、拆解與優先級排序的核心方法

#### 1.1 首要參考：系統架構思維導圖

**行動**:
1. **必須先閱讀** `docs/10-系統架構思維導圖.mermaid.md`
2. 了解完整系統架構（11 個模組、51 張表）
3. 理解任務系統在整體架構中的位置與依賴關係
4. 確認變更範圍與影響面

**為什麼重要**:
- 避免違反架構設計原則
- 理解跨模組依賴關係
- 確保變更符合整體設計思維
- 防止引入架構債

#### 1.2 使用 Sequential Thinking (@S7) 進行任務分析

**何時使用**:
- 所有 Level 3+ 複雜任務
- 涉及多個模組的變更
- 需要根因分析的問題
- 架構設計決策

**使用流程**:

步驟 1: 問題定義
├─ 明確問題陳述（是什麼？）
├─ 識別利益相關者（誰受影響？）
├─ 定義成功標準（怎樣算成功？）
└─ 評估影響範圍（波及哪些模組？）
```text
步驟 2: 現狀分析
├─ 檢視相關程式碼與資料表
├─ 識別現有限制與約束
├─ 分析技術債與依賴關係
└─ 評估風險與機會

步驟 3: 解決方案探索
├─ 腦力激盪多種方案（至少 3 個）
├─ 評估每個方案的優缺點
├─ 考慮技術可行性與資源需求
└─ 選擇最佳方案並說明理由

步驟 4: 依賴分析
├─ 識別需要的前置任務
├─ 分析對其他模組的影響
├─ 檢查資料庫 schema 變更需求
└─ 確認 API 變更影響範圍

步驟 5: 風險評估
├─ 技術風險（相容性、效能）
├─ 業務風險（資料遺失、停機）
├─ 安全風險（權限、資料暴露）
└─ 制定緩解措施
```

**輸出**: 結構化分析報告，包含問題定義、現狀、方案比較、依賴關係、風險評估

#### 1.3 使用 Software Planning Tool (@SPT) 進行任務拆解

**何時使用**:
- 所有 Level 3+ 複雜任務（必須）
- 需要多步驟執行的任務
- 需要追蹤進度的長期任務
- 團隊協作的大型功能

**使用流程**:

步驟 1: 建立任務計畫
├─ 設定任務目標（goal）
├─ 定義驗收標準
└─ 估算總體複雜度

步驟 2: 任務拆解
```text
│  ├─ 每個子任務應該是可獨立完成的
│  ├─ 子任務應該有清晰的輸入/輸出
│  └─ 子任務複雜度建議 ≤ 5
├─ 為每個子任務命名（描述性）
├─ 撰寫詳細描述
└─ 可選：提供程式碼範例

步驟 3: 設定優先級與複雜度
├─ 評估每個子任務的複雜度（0-10）
│  ├─ 0-2: 簡單（<1 小時）
│  ├─ 3-5: 中等（1-4 小時）
│  ├─ 6-8: 複雜（4-8 小時）
│  └─ 9-10: 非常複雜（>8 小時，需再拆解）
├─ 設定執行順序
└─ 識別阻塞關係

步驟 4: 執行與追蹤
├─ 按順序完成子任務
├─ 完成後更新狀態（update_todo_status）
├─ 記錄實際耗時與學習
└─ 必要時調整計畫
```

**輸出**: 結構化任務清單，包含標題、描述、複雜度、優先級、狀態

#### 1.4 @S7 與 @SPT 整合工作流

**推薦流程**:

1. 收到任務
   ↓
2. 使用 @S7 分析任務（思考）
   - 理解問題本質
   - 探索解決方案
   - 評估風險與依賴
   ↓
```text
   - 拆解為可執行步驟
   - 設定優先級
   - 追蹤進度
   ↓
4. 執行子任務
   ↓
5. 遇到複雜子任務？
   - 是 → 回到步驟 2（使用 @S7 再分析）
   - 否 → 繼續執行
   ↓
6. 所有子任務完成
   ↓
7. 驗證與測試
```

#### 1.5 企業標準檢查點

**在開始開發前，必須確認**:

- [ ] **架構對齊**: 變更符合 `docs/10-系統架構思維導圖.mermaid.md`
- [ ] **文檔閱讀**: 已閱讀相關優先級最高文檔（見本文「📚 文檔清單」）
- [ ] **問題定義**: 使用 @S7 產生清晰的問題陳述
- [ ] **方案評估**: 至少考慮 2-3 個方案並說明選擇理由
- [ ] **任務拆解**: Level 3+ 任務使用 @SPT 拆解為子任務
- [ ] **依賴識別**: 明確列出所有依賴項（模組、API、資料表）
- [ ] **風險評估**: 識別技術、業務、安全風險並制定緩解措施
- [ ] **測試計畫**: 規劃單元測試、整合測試策略
- [ ] **回滾計畫**: 制定變更失敗時的回滾方案

**質量門檻**:

| 檢查項 | Level 1-2 | Level 3-5 | Level 6-8 | Level 9-10 |
|--------|-----------|-----------|-----------|------------|
| 使用 @S7 | 建議 | 必須 | 必須 | 必須 |
| 使用 @SPT | 不需要 | 必須 | 必須 | 必須 |
| 文檔數量 | 0-2 | 2-5 | 5-8 | 8+ |
| 測試覆蓋率 | 60%+ | 80%+ | 85%+ | 90%+ |
| Code Review | 可選 | 必須 | 必須 | 必須（2+ 人）|

### 步驟 2：開發推進

#### 2.1 將大任務分解為子任務

#### 2.2 為每個子任務設置優先級與預估時間

#### 2.3 使用 Sequential Thinking 分析任務順序

#### 2.4 如有需要，調用 Context7 或 Supabase MCP 協作

#### 2.5 完成任務後，執行 build 或專案對應 build 指令

#### 2.6 記錄錯誤資訊

- --

## ⚠️ 錯誤處理

### 步驟 1：執行構建
執行 `yarn build` 或對應 build 指令

### 步驟 2：記錄錯誤資訊

### 步驟 3：根據錯誤類型採取對應措施

| 錯誤類型 | 處理方式 | 命令 |
|----------|----------|------|
| 類型錯誤 | 執行 `yarn type-check` 並修復 | `yarn type-check` |
| 代碼風格 | 執行 `yarn lint` 並修復 | `yarn lint` |
| 樣式錯誤 | 執行 `yarn lint:style` 並修復 | `yarn lint:style` |
| 構建錯誤 | 檢查 angular.json 配置 | 檢查配置文件 |

### 步驟 4：驗證修復
重新執行構建確保通過

- --

## 🎯 思考框架實戰範例

### 範例 1: Level 1-2 簡單任務（修復 UI Bug）

**任務**: 修復任務列表排序錯誤

**流程**:
1. 問題識別
   - 任務列表按建立時間排序，應該按優先級排序

2. 直接開發（無需 @S7/@SPT）
   - 修改 task-list.component.ts
   - 更改排序邏輯：created_at → priority

3. 測試
```mermaid
   - 執行相關單元測試

4. 提交
   - git commit -m "fix: correct task list sorting to use priority"
```

**耗時**: ~30 分鐘
**檢查點**: Lint + 手動測試

- --

### 範例 2: Level 3-5 中等任務（新增功能）

**任務**: 為任務新增「標籤」功能

**階段 1: 使用 @S7 分析**

```markdown
## 問題定義
- 需求：用戶希望為任務新增多個標籤以便分類
- 利益相關者：專案經理、工地主任、施工人員
- 成功標準：可新增/編輯/刪除標籤，可按標籤篩選任務

## 現狀分析
- 當前 tasks 表無標籤欄位
- 需要考慮多對多關係（一個任務多個標籤）
- 需要標籤管理介面

## 解決方案探索

方案 A: JSONB 欄位存標籤陣列
優點：簡單、無需新表
缺點：難以搜尋、無法統計標籤使用量

方案 B: 多對多關聯表（推薦）
優點：易搜尋、可統計、正規化
缺點：需要新表、join 查詢

方案 C: 使用 PostgreSQL 陣列 + GIN 索引
優點：平衡性能與查詢能力
缺點：較複雜的查詢語法

**選擇方案 B**: 標準關聯式設計，易維護

## 依賴分析
- 需要新增 2 張表：tags、task_tags
- 需要修改 task 相關 API
- 需要新增標籤管理 UI
- 需要更新 task-list 篩選器

## 風險評估
- 技術風險：低（標準 CRUD）
- 業務風險：低（不影響現有功能）
- 安全風險：需要 RLS 策略
```

**階段 2: 使用 @SPT 規劃**

```markdown
## 任務拆解

### 子任務 1: 資料庫 Schema（複雜度 3）
- 新增 tags 表
- 新增 task_tags 表
- 設定 RLS 策略
- 撰寫 migration

### 子任務 2: 後端 API（複雜度 4）
- 新增 TagRepository
- 新增 CRUD endpoints
- 更新 TaskRepository（關聯標籤）
- 撰寫單元測試

### 子任務 3: 前端 Service（複雜度 3）
- 新增 TagService
- 更新 TaskService
- 型別定義（Tag, TaskTag）

### 子任務 4: UI 組件（複雜度 5）
- 標籤管理頁面
- 標籤選擇器組件
- 任務列表標籤篩選
- 樣式調整

### 子任務 5: 測試與驗證（複雜度 4）
- 單元測試
- 整合測試
- E2E 測試關鍵流程
- 手動測試

## 執行順序
1 → 2 → 3 → 4 → 5

## 預估時間
總計：約 2-3 天
```

**檢查點**:
- [ ] Schema Review（資料庫專家）
- [ ] API Contract Review（後端團隊）
- [ ] UI/UX Review（設計師）
- [ ] Code Review（2+ 人）
- [ ] 測試覆蓋率 ≥ 80%

- --

### 範例 3: Level 6-8 複雜任務（跨模組重構）

**任務**: 實作「待辦中心即時同步」功能

**階段 1: 使用 @SC7/@SSC7 分析（跨模組）**

```markdown
## 問題定義
- 需求：待辦事項變更時，所有用戶裝置即時同步
- 涉及模組：
  - 任務模組（tasks）
  - 待辦中心（personal_todos）
  - 通知模組（notifications）
  - Supabase Realtime
- 成功標準：<2 秒延遲、零訊息遺失、支援離線

## 現狀分析
- 目前使用 polling（每 30 秒）
- 高延遲、浪費資源
- 無離線支援

## 技術方案（使用 @C7 查詢最佳實踐）
- Supabase Realtime WebSocket
- PostgreSQL LISTEN/NOTIFY
- Service Worker 快取
- Optimistic UI updates

## 跨模組依賴分析

### 任務模組
- 影響：task 狀態變更時需觸發 realtime 事件
- 變更：新增 Database Trigger

### 待辦中心
- 影響：需要訂閱 realtime channel
- 變更：新增 RealtimeService、狀態管理

### 通知模組
- 影響：任務變更需發送通知
- 變更：整合 realtime 推送

### Supabase Layer
- 影響：需要設定 realtime 策略
- 變更：RLS policy、channel 權限

## 風險評估（高複雜度）
- 技術風險：中（WebSocket 連線穩定性）
- 業務風險：中（影響多個模組）
- 安全風險：高（realtime 權限控制）
- 效能風險：中（大量連線）

## 緩解措施
- 連線重試機制
- 訊息佇列防遺失
- 嚴格 RLS 策略
- 限流與節流
```

**階段 2: 使用 @SPT 規劃（複雜拆解）**

```markdown
## 階段式開發計畫

### Phase 1: 基礎建設（Week 1）
- [ ] 子任務 1.1: Supabase Realtime 設定（複雜度 5）
- [ ] 子任務 1.2: Database Triggers（複雜度 6）
- [ ] 子任務 1.3: RLS 策略調整（複雜度 7）
- [ ] 子任務 1.4: RealtimeService 基礎實作（複雜度 5）

### Phase 2: 核心功能（Week 2）
- [ ] 子任務 2.1: 任務變更事件發送（複雜度 5）
- [ ] 子任務 2.2: 待辦中心訂閱實作（複雜度 6）
- [ ] 子任務 2.3: Optimistic UI updates（複雜度 7）
- [ ] 子任務 2.4: 錯誤處理與重試（複雜度 6）

### Phase 3: 進階功能（Week 3）
- [ ] 子任務 3.1: 離線支援（複雜度 8）
- [ ] 子任務 3.2: 衝突解決機制（複雜度 8）
- [ ] 子任務 3.3: 效能優化（複雜度 6）
- [ ] 子任務 3.4: 監控與日誌（複雜度 5）

### Phase 4: 測試與上線（Week 4）
- [ ] 子任務 4.1: 單元測試（複雜度 6）
- [ ] 子任務 4.2: 整合測試（複雜度 7）
- [ ] 子任務 4.3: 負載測試（複雜度 6）
- [ ] 子任務 4.4: 灰度發布（複雜度 5）

## 關鍵里程碑
- Week 1 End: 基礎建設完成，可建立 realtime 連線
- Week 2 End: 核心功能完成，待辦事項可即時同步
- Week 3 End: 進階功能完成，支援離線與衝突解決
- Week 4 End: 測試通過，正式上線

## 預估時間
總計：約 4 週（1 位全職工程師）
```

**檢查點（每週）**:
- [ ] 技術設計文檔 Review
- [ ] 安全審查（Realtime 權限）
- [ ] 效能測試（WebSocket 連線數）
- [ ] Code Review（每個 Phase）
- [ ] 整合測試通過
- [ ] 灰度發布驗證

- --

### 範例 4: 決策樹 - 何時使用哪個工具

收到任務
    ↓
是否為 Level 3+ 複雜任務？
    ├─ 否 → 直接開發（範例 1）
    └─ 是 ↓
        是否涉及多個模組？
            ├─ 否 → 使用 @S7 + @SPT（範例 2）
            └─ 是 ↓
                使用 @SC7/@SSC7 + @SPT（範例 3）
```text
                需要查詢技術文檔？
                    ├─ 是 → 加入 @C7
                    └─ 否 → 繼續
                        ↓
                    需要資料庫操作？
                        ├─ 是 → 加入 @SUPABASE
                        └─ 否 → 繼續開發
```

### 範例 5: 工具組合使用模式

**模式 A: 標準開發流程（Level 3-5）**
@S7（分析）→ @SPT（規劃）→ 開發 → 測試









```text
```

**模式 B: 技術調研流程（新技術）**
@C7（查詢文檔）→ @S7（評估方案）→ @SPT（規劃 POC）→ 開發
```text
```

**模式 C: 跨模組重構流程（Level 6-8）**
@SC7/@SSC7（依賴分析）→ @S7（風險評估）→ @SPT（階段規劃）→ 開發
```text
```

**模式 D: 資料庫變更流程**
@SUPABASE（檢查 schema）→ @S7（影響分析）→ @SPT（migration 規劃）→ 開發
```text
```

**模式 E: 問題修復流程（複雜 Bug）**
@S7（根因分析）→ @SUPABASE（資料驗證）→ @SPT（修復規劃）→ 開發
```text
```

- --

## ✅ 驗證清單

### 提交前必須通過

- [ ] `yarn lint` - 代碼檢查無錯誤
- [ ] `yarn type-check` - 類型檢查通過
- [ ] `yarn test` - 單元測試通過
- [ ] `yarn build` - 構建成功
- [ ] 瀏覽器 Console - 無錯誤

### 關鍵檢查項

| 檢查項 | 描述 | 是否必需 |
|--------|------|----------|
| SHARED_IMPORTS | 使用 SHARED_IMPORTS（UI層） | ✅ 是 |
| 分層架構 | 遵循分層架構（routes → shared → core） | ✅ 是 |
| Signals | 使用 Signals 管理狀態 | ✅ 是 |
| OnPush | 使用 OnPush 變更檢測策略 | ✅ 是 |

- --

## 💻 命令

### 開發命令

| 命令 | 描述 |
|------|------|
| `yarn start` | 啟動開發服務器 |
| `yarn hmr` | 熱模組替換模式 |

### 檢查命令

| 命令 | 描述 |
|------|------|
| `yarn lint` | 代碼檢查 |
| `yarn type-check` | 類型檢查 |
| `yarn test` | 運行測試 |
| `yarn build` | 構建項目 |

### 修復命令

| 命令 | 描述 |
|------|------|
| `yarn lint --fix` | 自動修復代碼風格 |
| `npx prettier --write "src/**/*.{ts,html,less}"` | 格式化代碼 |

- --

## 🏗️ 技術棧

### 版本要求

| 技術 | 版本 |
|------|------|
| Angular | 20.3.x |
| ngZorro | 20.3.x |
| ngAlain | 20.0.x |
| Node.js | >= 20 |
| Yarn | 4.9.2+ |
| TypeScript | strict mode |
| Supabase | 最新版本 |

### 關鍵特性

- Standalone Components
- Signals 狀態管理
- ChangeDetectionStrategy.OnPush
- Typed Forms
- 現代控制流程（`@if`, `@for`, `@switch`）

- --

## 🏛️ 架構

### 系統架構總覽

本任務系統是完整工地管理系統的一部分。完整系統包含：

#### 11 個核心模組（51 張表）

1. **🔐 帳戶與身份** (4 表): accounts, teams, team_members, organization_schedules
2. **🤝 組織協作** (3 表): organization_collaborations, collaboration_invitations, collaboration_members
3. **🔒 權限管理** (5 表): roles, user_roles, permissions, role_permissions, branch_permissions
4. **🎯 藍圖/專案** (5 表): blueprints, blueprint_configs, blueprint_branches, branch_forks, pull_requests
5. **📋 任務執行** (9 表): ⭐ 本指令重點模組
6. **✅ 品質保證** (4 表): quality_checks, qc_photos, inspections, inspection_photos
7. **⚠️ 問題追蹤** (4 表): issues, issue_assignments, issue_photos, issue_sync_logs
8. **💬 協作溝通** (6 表): comments, notifications, notification_rules, notification_subscriptions, personal_todos, todo_status_tracking
9. **📊 資料分析** (6 表): documents, document_versions, document_thumbnails, progress_tracking, activity_logs, analytics_cache
10. **🤖 機器人系統** (3 表): bots, bot_tasks, bot_execution_logs
11. **⚙️ 系統管理** (2 表): settings, feature_flags

**詳細架構**: 請參考 [`docs/10-系統架構思維導圖.mermaid.md`](./10-系統架構思維導圖.mermaid.md)

- --

### 任務系統在整體架構中的位置

┌─────────────────────────────────────────────────────────────┐
```text
│                                                              │
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   │
│  │  🔐 帳戶層   │   │  🎯 專案層   │   │  📋 任務層   │   │
│  │              │──▶│  (藍圖分支)  │──▶│  ⭐ 本文重點 │   │
│  │  認證/授權   │   │              │   │              │   │
│  └──────────────┘   └──────────────┘   └──────┬───────┘   │
│                                                 │           │
│  ┌──────────────┐   ┌──────────────┐          │           │
│  │  ✅ 品質層   │   │  ⚠️ 問題層   │          │           │
│  │              │◀──┤              │◀─────────┘           │
│  │  驗收/品管   │   │  問題追蹤    │                       │
│  └──────────────┘   └──────────────┘                       │
│                                                              │
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   │
│  │  💬 溝通層   │   │  📊 分析層   │   │  🤖 機器人   │   │
│  │  待辦/通知   │   │  報表/日誌   │   │  自動化      │   │
│  └──────────────┘   └──────────────┘   └──────────────┘   │
│                                                              │
│  ┌────────────────────────────────────────────────────┐    │
│  │           ⚡ Supabase 核心服務                      │    │
│  │  PostgreSQL | Storage | Realtime | Edge Functions │    │
│  └────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

- --

### Git-like 分支模型

系統採用 Git-like 分支模型，包含以下組件：

#### 主分支 (`blueprints`)
- **描述**: 擁有者全權控制任務結構

#### 組織分支 (`blueprint_branches`)
- **描述**: 協作組織只能填寫承攬欄位

#### Pull Request
- **描述**: 提交執行數據 → 擁有者審核 → 合併更新

### 資料庫

- **總表數**: 51 張
- **模組數**: 11 個
- **描述**: 系統共包含 51 張資料表，分為 11 個模組

### 核心設計原則

1. **暫存區機制**: 48h 可撤回
2. **待辦中心**: 五種狀態分類
3. **問題同步**: 即時同步至主分支
4. **活動記錄**: 集中記錄
5. **文件管理**: 版本控制、縮圖、軟刪除

- --

## 📝 注意事項

### 重要提醒

- ✅ 所有資料庫操作必須透過 `@SUPABASE` MCP 工具
- ✅ UI 層必須使用 SHARED_IMPORTS
- ✅ 遵循分層架構：routes → shared → core
- ✅ 使用 Signals 進行狀態管理
- ✅ 使用 OnPush 變更檢測策略

### 禁止事項

- ❌ 禁止使用 workaround 或臨時解決方案
- ❌ 禁止繞過 PR 機制直接更新主分支數據
- ❌ 禁止協作組織修改任務結構（只能填寫承攬欄位）

- --

**最後更新**: 2025-11-16
**版本**: 2.0

- --

## 📝 版本歷史

### v2.0 (2025-11-16) - 思考框架強化版

**重大更新**:
- ✅ **大幅擴展「步驟 1：建立思考框架」** - 新增詳細的 @S7 和 @SPT 使用流程
- ✅ **新增「思考框架實戰範例」章節** - 包含 5 個實戰範例（Level 1-2 到 Level 6-8）
- ✅ **強化工具說明** - 將工具章節重新組織為「核心方法」與「輔助工具」
- ✅ **新增工具使用指引矩陣** - 清楚標示不同複雜度任務應使用的工具
- ✅ **新增系統架構總覽** - 說明任務系統在完整架構中的位置
- ✅ **新增快速導覽** - 幫助開發者快速找到所需資訊
- ✅ **強調系統架構思維導圖** - 作為首要參考文檔

**改進項目**:
- 企業標準檢查點更詳細
- 質量門檻更明確
- 工具組合使用模式更完善
- 決策樹更實用

**目標**:
- 確保 Sequential Thinking 與 Software Planning Tool 成為任務開發的核心方法
- 達到企業級開發標準
- 提供可操作的實戰指引

- --

### v1.0 (2025-01-15) - 初始版本

**包含內容**:
- 文檔清單與閱讀順序
- 任務系統資料表說明（9 張表）
- 待辦中心說明（2 張表）
- 狀態流轉（8 種狀態）
- 工具簡介
- 基礎開發流程
- 錯誤處理
- 驗證清單
- 命令參考

- --

## 📚 相關文檔

### 必讀文檔（按閱讀順序）

1. **[10-系統架構思維導圖.mermaid.md](./10-系統架構思維導圖.mermaid.md)** ⭐⭐⭐⭐⭐
   - 完整系統架構（11 模組、51 表）
   - 所有設計決策的依據

2. **[50-AI助手角色配置.md](./reference/ai-assistant-role-configuration.md)** ⭐⭐⭐⭐⭐
   - AI 助手行為規範
   - 回覆格式要求
   - 企業標準定義

3. **[27-完整架構流程圖.mermaid.md](./architecture/20-complete-architecture-flowchart.mermaid.md)** ⭐⭐⭐⭐
   - Git-like 分支模型
   - 任務執行流程
   - 待辦中心機制

4. **[28-架構審查報告.md](./architecture/21-architecture-review-report.md)** ⭐⭐⭐⭐
   - 架構決策理由
   - 設計原則
   - 最佳實踐

5. **[30-0-完整SQL表結構定義.md](./30-0-完整SQL表結構定義.md)** ⭐⭐⭐⭐
   - 51 張表完整定義
   - 任務相關表在第 469-703 行

### 參考文檔

- [00-開發作業指引.md](./specs/00-development-guidelines.md) - 開發規範
- [14-業務流程圖.mermaid.md](./14-業務流程圖.mermaid.md) - 業務流程
- [16-狀態圖.mermaid.md](./16-狀態圖.mermaid.md) - 狀態流轉
- [43-狀態枚舉值定義.md](./43-狀態枚舉值定義.md) - 狀態定義
- [45-SHARED_IMPORTS-使用指南.md](./reference/shared-imports-guide.md) - 共享模組

- --

## 💬 意見回饋

如對此指令文檔有任何建議，請：

1. 在 GitHub 開 issue 並標籤 `documentation`
2. 或直接提交 PR 修改此文檔
3. 在團隊會議中提出討論

**維護者**：開發團隊
**聯絡方式**：透過 GitHub Issues

