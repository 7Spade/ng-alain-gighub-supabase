# 資料表清單總覽 v2.0

## 📑 目錄

- [📊 資料表分類統計](#-資料表分類統計)
- [📋 完整資料表清單](#-完整資料表清單)
  - [🔐 帳戶與身份系統 (4 張)](#-帳戶與身份系統-4-張)
  - [🤝 組織協作系統 (3 張)](#-組織協作系統-3-張)
  - [🔒 權限系統 (5 張)](#-權限系統-5-張)
  - [🎯 藍圖/專案系統 (5 張) - Git-like 分支模型](#-藍圖專案系統-5-張---git-like-分支模型)
  - [📋 任務執行系統 (9 張)](#-任務執行系統-9-張)
  - [✅ 品質驗收系統 (4 張)](#-品質驗收系統-4-張)
  - [⚠️ 問題追蹤系統 (4 張)](#-問題追蹤系統-4-張)
  - [💬 協作溝通系統 (6 張)](#-協作溝通系統-6-張)
  - [📊 資料分析系統 (6 張)](#-資料分析系統-6-張)
  - [🤖 機器人系統 (3 張)](#-機器人系統-3-張)
  - [⚙️ 系統管理 (2 張)](#-系統管理-2-張)
- [🎯 核心設計原則總結](#-核心設計原則總結)
  - [1. Git-like 分支模型](#1-git-like-分支模型)
  - [2. 權限分離架構](#2-權限分離架構)
  - [3. 數據同步機制](#3-數據同步機制)
  - [4. 暫存區設計](#4-暫存區設計)
  - [5. 待辦中心分類](#5-待辦中心分類)
- [📋 關鍵關聯關係圖](#-關鍵關聯關係圖)
  - [藍圖 → 分支 → PR 流程](#藍圖--分支--pr-流程)
  - [任務執行流程](#任務執行流程)
  - [問題同步機制](#問題同步機制)
- [📝 注意事項](#-注意事項)
  - [Supabase Auth 內建表](#supabase-auth-內建表)
  - [資料表命名規範](#資料表命名規範)
  - [外鍵關聯](#外鍵關聯)
- [📚 相關文檔連結](#-相關文檔連結)
- [📊 統計摘要](#-統計摘要)
- [🎯 結論](#-結論)

---


> 📋 **目的**：提供 51 張資料表的分類總覽，快速了解系統資料庫架構

根據最新架構設計（`27-完整架構流程圖.mermaid.md`, `28-架構審查報告.md`），系統共需要 **51 張資料表**（不包括 Supabase Auth 內建的 `auth.users` 表）。

**最後更新**：2025-11-15
**維護者**：開發團隊

- --

## 📊 資料表分類統計

| 分類 | 數量 | 說明 |
|------|------|------|
| 🔐 帳戶與身份系統 | 4 張 | 統一身份抽象、團隊、排班 |
| 🤝 組織協作系統 | 3 張 | 跨組織協作、邀請管理 |
| 🔒 權限系統 | 5 張 | 角色權限、分支權限控制 |
| 🎯 藍圖/專案系統 | 5 張 | Git-like 分支模型 |
| 📋 任務執行系統 | 9 張 | 樹狀任務、暫存區、日誌 |
| ✅ 品質驗收系統 | 4 張 | 品管、驗收、責任切割 |
| ⚠️ 問題追蹤系統 | 4 張 | 問題管理、跨分支同步 |
| 💬 協作溝通系統 | 6 張 | 留言、通知、待辦中心 |
| 📊 資料分析系統 | 6 張 | 文件管理、進度追蹤、分析快取 |
| 🤖 機器人系統 | 3 張 | Bot 定義、任務、執行日誌 |
| ⚙️ 系統管理 | 2 張 | 系統設定、功能開關 |
| **總計** | **51 張** | |

- --

## 📋 完整資料表清單

### 🔐 帳戶與身份系統 (4 張)

1. **accounts** - 帳戶主表（統一身份抽象，支援 User/Bot/Organization）
2. **teams** - 團隊表
3. **team_members** - 團隊成員表
4. **organization_schedules** - 組織排班表（跨藍圖成員調派）

### 🤝 組織協作系統 (3 張)

5. **organization_collaborations** - 組織協作關係表（1:1 承攬關係）
6. **collaboration_invitations** - 協作邀請表
7. **collaboration_members** - 協作成員表

### 🔒 權限系統 (5 張)

8. **roles** - 角色定義表
9. **user_roles** - 用戶角色關聯表
10. **permissions** - 權限定義表
11. **role_permissions** - 角色權限關聯表
12. **branch_permissions** - 分支權限表（分支層級權限控制）

### 🎯 藍圖/專案系統 (5 張) - Git-like 分支模型

13. **blueprints** - 藍圖主表（主分支，擁有者組織控制任務結構）
14. **blueprint_configs** - 藍圖設定表
15. **blueprint_branches** - 組織分支表（協作組織的 Fork 分支）
16. **branch_forks** - 分支 Fork 記錄表
17. **pull_requests** - PR 提交記錄表（提交執行數據，擁有者審核後合併）

### 📋 任務執行系統 (9 張)

18. **tasks** - 任務主表（樹狀結構，無層級限制）
19. **task_assignments** - 任務指派表（支援個人/團隊/組織/承攬）
20. **task_lists** - 任務列表表（按指派對象分類）
21. **task_staging** - 暫存區表（48 小時可撤回機制）
22. **daily_reports** - 施工日誌表（自動同步到主分支）
23. **report_photos** - 報表照片表
24. **weather_cache** - 天氣快取表
25. **task_dependencies** - 任務依賴關係表
26. **task_templates** - 任務模板表

### ✅ 品質驗收系統 (4 張)

27. **quality_checks** - 品質管理表（品管檢查記錄）
28. **qc_photos** - 品管照片表
29. **inspections** - 驗收表（最終驗收/責任切割）
30. **inspection_photos** - 驗收照片表

### ⚠️ 問題追蹤系統 (4 張)

31. **issues** - 問題主表（施工異常問題追蹤）
32. **issue_assignments** - 問題指派表
33. **issue_photos** - 問題照片表
34. **issue_sync_logs** - 問題同步記錄表（跨分支問題即時同步至主分支）

### 💬 協作溝通系統 (6 張)

35. **comments** - 留言表（任務、問題的討論留言）
36. **notifications** - 通知表（系統通知記錄）
37. **notification_rules** - 通知規則表（用戶自訂通知規則）
38. **notification_subscriptions** - 通知訂閱表
39. **personal_todos** - 個人待辦中心表（五種狀態分類：待執行/暫存中/品管中/驗收中/問題追蹤）
40. **todo_status_tracking** - 待辦狀態追蹤表

### 📊 資料分析系統 (6 張)

41. **documents** - 文件元資料表（統一文件管理，支援版本控制、縮圖、軟刪除）
42. **document_versions** - 文件版本控制表
43. **document_thumbnails** - 圖片縮圖表
44. **progress_tracking** - 進度追蹤表（視覺化儀表板數據）
45. **activity_logs** - 活動記錄表（集中記錄所有操作，所有分支同步到主分支）
46. **analytics_cache** - 數據分析快取表（預計算的分析報表快取）

### 🤖 機器人系統 (3 張)

47. **bots** - 機器人定義表（定期報表、通知、備份）
48. **bot_tasks** - 機器人任務表（執行任務佇列）
49. **bot_execution_logs** - 機器人執行日誌表

### ⚙️ 系統管理 (2 張)

50. **settings** - 系統設定表
51. **feature_flags** - 功能開關表（灰度發布、A/B 測試）

- --

## 🎯 核心設計原則總結

### 1. Git-like 分支模型
- **主分支 (blueprints)**：擁有者全權控制任務結構
- **組織分支 (blueprint_branches)**：協作組織只能填寫承攬欄位
- **Pull Request**：提交執行數據 → 擁有者審核 → 合併更新

### 2. 權限分離架構
```text
✅ 建立/修改任務結構
✅ Fork 任務給協作組織
✅ 審核/合併 PR
✅ 查看所有分支數據

協作組織權限：
❌ 不能修改任務結構
✅ 只能填寫承攬欄位
✅ 提交執行數據 (PR)
✅ 查看自己分支數據
```

### 3. 數據同步機制
- **施工日誌**：自動同步到主分支
- **品管記錄**：自動同步到主分支
- **問題追蹤**：即時同步到主分支（所有分支問題統一可見）
- **活動記錄**：集中記錄在主分支（擁有者全局掌控）

### 4. 暫存區設計
- **48 小時緩衝期**：允許撤回提交
- **分階段確認**：提交 → 暫存 → 品管 → 驗收
- **責任切割點**：驗收通過後明確責任轉移

### 5. 待辦中心分類
個人待辦中心 (personal_todos)
```text
├── 🟨 暫存中 (task_staging)
├── 🟧 品管中 (quality_checks)
├── 🟥 驗收中 (inspections)
└── ⚠️ 問題追蹤 (issues)
```

- --

## 📋 關鍵關聯關係圖

### 藍圖 → 分支 → PR 流程
blueprints (主分支)
    ↓ 1:N
```text
    ↓ 1:N
pull_requests (提交執行數據)
    ↓ 審核通過
blueprints (更新承攬欄位)
```

### 任務執行流程
tasks (任務樹)
    ↓
task_assignments (指派)
```text
task_lists (待辦列表)
    ↓
task_staging (48h 暫存)
    ↓
daily_reports (施工日誌) + quality_checks (品管)
    ↓
inspections (驗收/責任切割)
    ↓
progress_tracking (進度儀表板)
```

### 問題同步機制
issues (分支問題)
    ↓ 即時同步
issue_sync_logs
    ↓
```text
```

- --

## 📝 注意事項

### Supabase Auth 內建表
- **`auth.users`** - Supabase Auth 內建，不需要手動建立
- 透過 `auth.uid()` 在 RLS Policy 中使用

### 資料表命名規範
- 所有表名使用 **小寫 + 底線**（snake_case）
- 複數形式（如 `tasks`, `documents`）
- 關聯表使用 `{entity1}_{entity2}` 格式（如 `task_assignments`）

### 外鍵關聯
- 所有表都有 `id` 主鍵（UUID）
- 外鍵命名：`{table}_id`（如 `blueprint_id`, `account_id`）
- 時間戳記：`created_at`, `updated_at`

- --

## 📚 相關文檔連結

- **完整 SQL 表結構**：`30-0-完整SQL表結構定義.md`（包含所有 51 張表的完整 SQL 定義）
- **實體關係圖**：`12-實體關係圖.mermaid.md`
- **帳戶層流程圖**：`13-帳戶層流程圖.mermaid.md`
- **架構流程圖**：`27-完整架構流程圖.mermaid.md`
- **架構審查報告**：`28-架構審查報告.md`

- --

## 📊 統計摘要

- **總表數**: 51 張
- **帳戶系統**: 4 張
- **組織協作系統**: 3 張
- **權限系統**: 5 張
- **藍圖系統**: 5 張（Git-like 分支模型）
- **任務系統**: 9 張
- **品質系統**: 4 張
- **問題系統**: 4 張
- **協作系統**: 6 張
- **資料系統**: 6 張
- **機器人系統**: 3 張
- **系統管理**: 2 張

- --

## 🎯 結論

根據最新架構設計（`27-完整架構流程圖.mermaid.md`, `28-架構審查報告.md`），系統需要建立 **51 張資料表**（不包括 Supabase Auth 內建的 `auth.users`）。

完整的 SQL 表結構定義請參考 `30-0-完整SQL表結構定義.md` 文檔。

- --

**文件版本**: v2.0
**最後更新**: 2025-01-15
**維護者**: 系統架構團隊

